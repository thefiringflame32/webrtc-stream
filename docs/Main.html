<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Live Tab Sharing â€” Final</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/4.5.2/flatly/bootstrap.min.css"/>
  <style>
    :root{
      --card-radius:18px;
      --muted:#6b7280;
      --accent:#2563eb;
      --bg:#f6f8fb;
      --panel:#ffffff;
      --star-color:#f59e0b;
      --accent-2:#0ea5a4;
    }
    html,body{height:100%;box-sizing:border-box}
    body{background:linear-gradient(180deg,#eef6ff 0%, #fbfcff 100%);font-family:Inter, 'Segoe UI', Roboto, system-ui, sans-serif;margin:0;padding:18px;color:#111}

    /* Stage layout */
    .stage{max-width:1320px;margin:0 auto;height:calc(100vh - 36px);display:flex;align-items:flex-start;gap:28px}

    /* LEFT info column */
    .left-col{width:260px;display:flex;flex-direction:column;gap:14px}
    .logo-top{height:66px;width:220px;border-radius:12px;background:var(--panel);display:flex;align-items:center;padding:8px 14px;box-shadow:0 8px 22px rgba(16,24,40,.06);position:relative}
    .logo-top img{max-width:100%;max-height:48px;display:block}
    .logo-fallback{display:flex;flex-direction:column}
    .logo-fallback .line1{font-weight:900;color:var(--accent);font-family:'Segoe UI',Arial;font-size:15px}
    .logo-fallback .line2{font-weight:800;color:#333;margin-top:2px;font-size:13px}
    .info-card{flex:1;border-radius:14px;background:var(--panel);padding:18px;box-shadow:0 10px 30px rgba(16,24,40,.04);position:relative;overflow:hidden;display:flex;flex-direction:column}
    .info-card h5{margin:0 0 8px 0}
    .big-answer{margin-top:12px;background:linear-gradient(180deg,#fbfdff,#f8fbff);border-radius:12px;padding:18px;border:2px solid rgba(0,0,0,.05);min-height:200px;box-sizing:border-box;color:#1f2937;flex:1;display:flex;flex-direction:column;justify-content:flex-start}
    .answer-text{line-height:1.45;color:#1f2937}
    .question-buttons{display:flex;flex-direction:row;gap:10px;margin-top:12px}
    .q-btn{flex:1;height:48px;border-radius:10px;border:2px solid rgba(0,0,0,.06);background:var(--panel);display:flex;align-items:center;justify-content:center;font-weight:700;cursor:pointer}
    .q-btn:hover{box-shadow:0 6px 20px rgba(16,24,40,.06)}

    /* CENTER auth card */
    .center-col{flex:1;display:flex;align-items:center;justify-content:center}
    .auth-card{width:820px;border-radius:28px;background:linear-gradient(180deg,#f8fbff,#f4f8ff);padding:28px 28px 44px 28px;box-shadow:0 24px 80px rgba(12,30,60,.06);position:relative;display:flex;flex-direction:column;align-items:center;justify-content:center}
    .corner-logo{position:absolute;left:18px;top:12px;width:160px;height:44px;border-radius:10px;background:var(--panel);display:flex;align-items:center;justify-content:center;font-weight:900;color:var(--accent);box-shadow:0 8px 24px rgba(12,30,60,.04)}
    .corner-logo img{max-height:36px;max-width:140px;display:block}
    .auth-tabs{display:flex;gap:12px;justify-content:center;margin-bottom:22px;width:100%}
    .tab{padding:12px 22px;border-radius:12px;background:var(--panel);border:2px solid rgba(0,0,0,.06);text-align:center;font-weight:800;font-size:1.02rem;cursor:pointer;min-width:160px}
    .tab.active{border-color:rgba(37,99,235,.18);box-shadow:inset 0 -4px 0 rgba(37,99,235,.06)}
    .auth-body{display:flex;flex-direction:column;align-items:center;gap:12px;width:100%}
    .big-input{width:460px;padding:16px;border-radius:12px;border:2px solid rgba(0,0,0,.08);background:var(--panel);font-size:1rem}
    .muted-link{font-size:0.95rem;color:var(--muted);text-decoration:underline;cursor:pointer}
    .submit-btn{margin-top:8px;width:320px;padding:14px;border-radius:12px;border:none;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white;font-weight:800;cursor:pointer;box-shadow:0 8px 30px rgba(37,99,235,.14)}

    /* RIGHT reviews rail (vertical larger stars) */
    .right-col{width:160px;display:flex;flex-direction:column;align-items:center}
    .reviews-rail{width:160px;border-radius:12px;background:var(--panel);padding:16px;display:flex;flex-direction:column;align-items:center;justify-content:space-between;height:calc(100vh - 120px);box-shadow:0 12px 36px rgba(12,30,60,.04)}
    .reviews-rail h5{margin:0;font-weight:800;letter-spacing:0.6px}
    .stars-vertical{display:flex;flex-direction:column;gap:14px;margin-top:16px;align-items:center}
    .star-big{width:54px;height:54px}
    .rating-bubble{background:linear-gradient(90deg,#fff,#fbfdff);border-radius:12px;padding:10px 14px;font-weight:800;border:1px solid rgba(0,0,0,.06);font-size:1rem;box-shadow:0 8px 20px rgba(12,30,60,.04)}

    /* viewer area (replicating the 'old' image but bigger) */
    .viewer-old { display:flex; gap:20px; align-items:flex-start; height:calc(100vh - 36px); max-width:1320px; margin:18px auto; }
    .players-panel { width:300px; background:#f3f3f3; border-radius:20px; padding:18px; border:2px solid #bdbdbd; box-shadow: inset 0 2px 0 rgba(255,255,255,.6); }
    .players-panel h3 { margin:0; font-size:26px; text-align:center; font-weight:900; }
    .players-list { margin-top:14px; display:flex; flex-direction:column; gap:12px; padding:6px; border-radius:12px; background:linear-gradient(180deg,#fff,#f4f4f4); border:2px solid rgba(0,0,0,.06); height:84vh; overflow:auto; }
    .player-item { display:flex; align-items:center; justify-content:space-between; padding:14px 12px; border-radius:12px; border:2px solid rgba(0,0,0,.08); background:#fbfbfb; cursor:pointer; font-size:18px; }
    .player-item.selected { outline:6px solid rgba(0,0,0,.04); box-shadow: inset 0 0 0 6px rgba(0,0,0,.02); background:#f0f8ef; }
    .player-item .name { font-weight:900; font-size:18px; }
    .status-dot { width:22px; height:22px; border-radius:6px; border:2px solid rgba(0,0,0,.06); }
    .add-player-btn { margin-top:14px; width:100%; padding:12px; border-radius:10px; background:#e8e8e8; border:2px solid rgba(0,0,0,.08); font-weight:900; cursor:pointer; font-size:16px; }

    .center-panel { flex:1; background:#ececec; border-radius:26px; padding:20px; border:3px solid rgba(0,0,0,.08); min-height:84vh; display:flex; flex-direction:column; align-items:stretch; justify-content:flex-start; position:relative; }
    .current-player-badge { display:inline-block; padding:10px 14px; border-radius:10px; border:2px solid rgba(0,0,0,.12); background:#f6f6f6; font-weight:900; margin-bottom:12px; width:320px; text-align:left; font-size:18px; }
    .share-canvas { flex:1; border-radius:20px; background:#efefef; display:flex; align-items:center; justify-content:center; font-size:44px; color:#666; text-align:center; margin-top:12px; position:relative; }
    .downtime { margin-top:14px; color:#c00; font-weight:800; text-decoration:underline; cursor:default; }

    .right-mini { width:92px; display:flex; align-items:flex-start; justify-content:center; }
    .back-btn { width:56px; height:56px; border-radius:10px; border:2px solid rgba(0,0,0,.1); display:flex; align-items:center; justify-content:center; font-weight:800; cursor:pointer; background:#f7f7f7; font-size:18px; }

    /* side panel that toggles (initially hidden) */
    .side-panel {
      position:absolute;
      right:16px;
      top:70px;
      width:0;
      height:48px; /* closed thin bar equal to button height */
      background:linear-gradient(180deg,#ffffff,#f7f7ff);
      border-radius:10px;
      overflow:hidden;
      transition: width .28s ease, height .28s ease;
      box-shadow:0 8px 30px rgba(12,30,60,.06);
      display:flex;
      align-items:center;
      justify-content:center;
      border:1px solid rgba(0,0,0,.06);
      z-index:40;
    }
    .side-panel.open { width:320px; height:320px; right:26px; top:80px; }

    /* buy modal overlay */
    .modal-overlay{position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;z-index:1000}
    .modal-card{background:white;border-radius:12px;padding:18px;width:520px;max-width:92%;box-shadow:0 20px 60px rgba(0,0,0,.2)}

    /* small utility */
    .small-muted{color:var(--muted);font-size:.95rem}
    .muted{color:var(--muted)}
    .toast{position:fixed;right:18px;bottom:18px;background:#111;color:white;padding:10px 14px;border-radius:8px;opacity:.95}

    /* responsive */
    @media(max-width:1100px){
      .stage{flex-direction:column;align-items:stretch;height:auto}
      .left-col,.right-col{width:100%}
      .auth-card{width:100%;border-radius:18px;padding:18px}
      .reviews-rail{height:340px}
      .viewer-old{flex-direction:column; gap:12px}
      .players-panel{width:100%}
      .right-mini{width:100%; display:flex; justify-content:flex-end}
      .center-panel{min-height:320px}
      .side-panel.open { position:static; width:100%; height:220px; margin-top:12px; }
    }
  </style>
</head>
<body>

  <!-- AUTH stage (unchanged layout & markup) -->
  <div class="stage" id="authStart">
    <!-- LEFT: Q&A viewer area (hidden logo when on authStart if desired) -->
    <div class="left-col">
      <div class="logo-top" id="leftLogo">
        <img id="leftLogoImg" src="LogoInit.jpg" alt="Logo" onerror="this.style.display='none'">
        <div class="logo-fallback" id="leftLogoFallback" style="display:none">
          <div class="line1">R<span style="color:var(--accent)">oblox</span></div>
          <div class="line2">Life SHARE</div>
        </div>
      </div>

      <div class="info-card" id="infoCard">
        <h5 id="mainQTitle">What is this for?</h5>
        <div class="big-answer" id="mainAnswer">
          <div class="answer-text">
            Live Tab Sharing lets a host share a browser tab or entire screen in real time with viewers. A host creates a Player, starts sharing (video-only by default), and viewers connect using the Player's PeerID. Hosts control who stays (kick), select stream quality, and may enable remote control. Streams use WebRTC (encrypted); Firebase stores only session metadata (no media recordings are stored by default).
          </div>
        </div>

        <div class="question-buttons" style="margin-top:14px">
          <div id="qBtn1" class="q-btn">Why choose us?</div>
          <div id="qBtn2" class="q-btn">What about privacy?</div>
        </div>
      </div>
    </div>

    <!-- CENTER: auth card (unchanged) -->
    <div class="center-col">
      <div class="auth-card" role="main" aria-labelledby="authTitle">
        <div class="corner-logo" id="cornerLogo">
          <!-- only the logo image (no text) -->
          <img id="cornerLogoImg" src="LogoInit.jpg" alt="Logo" style="display:block" onerror="this.style.display='none'">
        </div>

        <div class="auth-tabs">
          <div id="tabLogin" class="tab active">LOGIN</div>
          <div id="tabRegister" class="tab">REGISTER</div>
        </div>

        <div class="auth-body" id="authBody">
          <!-- LOGIN -->
          <div id="loginForm" style="width:100%;display:flex;flex-direction:column;align-items:center;gap:12px">
            <input id="visualEmail" class="big-input" placeholder="Username/Email..." type="email" />
            <input id="visualPassword" class="big-input" placeholder="Password..." type="password" />
            <a id="forgotLink" class="muted-link">Forgot your password</a>
            <button id="visualSubmit" class="submit-btn">SUBMIT</button>
            <div id="loginMsg" class="small-muted" style="margin-top:6px"></div>
          </div>

          <!-- REGISTER -->
          <div id="registerForm" style="width:100%;display:none;flex-direction:column;align-items:center;gap:12px">
            <input id="regEmail" class="big-input" placeholder="Correo" type="email" />
            <input id="regPassword" class="big-input" placeholder="ContraseÃ±a" type="password" />
            <input id="regUsername" class="big-input" placeholder="Nombre (username pÃºblico)" type="text" />
            <div style="display:flex;gap:8px">
              <button id="registerBtnVisual" class="submit-btn" style="width:140px">Crear</button>
              <button id="cancelRegVisual" class="submit-btn" style="width:140px;background:#fff;color:#111;border:1px solid rgba(0,0,0,.06)">Cancelar</button>
            </div>
            <div id="regMsg" class="small-muted"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT: reviews rail (unchanged) -->
    <div class="right-col">
      <div class="reviews-rail" aria-hidden="false">
        <div style="text-align:center"><h5>REVIEWS</h5></div>
        <div class="stars-vertical" id="starsRail" style="margin-top:12px">
          <svg class="star-big" viewBox="0 0 24 24"><path fill="var(--star-color)" d="M12 .587l3.668 7.431L23.5 9.75l-5.667 5.535L19.335 24 12 19.897 4.665 24l1.502-8.715L.5 9.75l7.832-1.732z"/></svg>
          <svg class="star-big" viewBox="0 0 24 24"><path fill="var(--star-color)" d="M12 .587l3.668 7.431L23.5 9.75l-5.667 5.535L19.335 24 12 19.897 4.665 24l1.502-8.715L.5 9.75l7.832-1.732z"/></svg>
          <svg class="star-big" viewBox="0 0 24 24"><path fill="var(--star-color)" d="M12 .587l3.668 7.431L23.5 9.75l-5.667 5.535L19.335 24 12 19.897 4.665 24l1.502-8.715L.5 9.75l7.832-1.732z"/></svg>
          <svg class="star-big" viewBox="0 0 24 24"><path fill="var(--star-color)" d="M12 .587l3.668 7.431L23.5 9.75l-5.667 5.535L19.335 24 12 19.897 4.665 24l1.502-8.715L.5 9.75l7.832-1.732z"/></svg>
          <svg class="star-big" viewBox="0 0 24 24"><defs><linearGradient id="gPartialV" x1="0" x2="1" y1="0" y2="0"><stop offset="0%" stop-color="var(--star-color)"/><stop offset="92%" stop-color="var(--star-color)"/><stop offset="92.1%" stop-color="#e6e6e6"/><stop offset="100%" stop-color="#e6e6e6"/></linearGradient></defs><path fill="url(#gPartialV)" d="M12 .587l3.668 7.431L23.5 9.75l-5.667 5.535L19.335 24 12 19.897 4.665 24l1.502-8.715L.5 9.75l7.832-1.732z"/></svg>
        </div>

        <div class="rating-bubble" style="margin-top:18px">4.92 / 5</div>
      </div>
    </div>
  </div>

  <!-- NEW VIEWER layout -->
  <div id="viewerFull" style="display:none;">
    <div class="viewer-old">
      <!-- LEFT: Players column -->
      <div class="players-panel" aria-label="Players panel">
        <h3>PLAYERS</h3>
        <div class="players-list" id="playersListViewer">
          <!-- rendered by renderPlayersViewer() -->
        </div>
        <button id="addPlayer" class="add-player-btn">Add Player</button>
      </div>

      <!-- CENTER: large sharing canvas -->
      <div class="center-panel" id="centerShare">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <div class="current-player-badge" id="currentPlayerBadge">Select A Player</div>
          <div style="display:flex;gap:8px;align-items:center">
            <div class="muted small" id="shareStatusLabel">Status: Not connected</div>
          </div>
        </div>

        <div id="viewerVideoContainer" class="share-canvas">
          <div id="noShareMessage">
            Select A Player
          </div>
        </div>

        <!-- side panel toggled by the arrow -->
        <div id="sidePanel" class="side-panel" aria-hidden="true">
          <!-- no buttons for now -- empty frame -->
          <div style="padding:12px;text-align:center;color:#444">Side Frame (empty)</div>
        </div>
      </div>

      <!-- RIGHT: small nav / back -->
      <div class="right-mini">
        <div class="back-btn" id="viewerBackBtn" title="Toggle Panel">â–¶</div>
      </div>
    </div>
  </div>

  <!-- HOST APP area (unchanged) -->
  <div id="appMain" style="display:none">
    <div style="max-width:1200px;margin:18px auto;padding:18px;background:var(--panel);border-radius:12px;box-shadow:0 12px 36px rgba(12,30,60,.04)">
      <h3>Host view (Players)</h3>
      <div id="playersGrid" style="margin-top:12px;display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px"></div>
    </div>
  </div>

  <!-- Firebase & PeerJS -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/peerjs@1.4.7/dist/peerjs.min.js"></script>

  <script>
    /*********************** CONFIG (unchanged) ***********************/
    const firebaseConfig = {
      apiKey: "AIzaSyDLQGyXjRwrJ9O6RbVFtp-4uRNepAWdfrU",
      authDomain: "thefiringflame3210.firebaseapp.com",
      databaseURL: "https://thefiringflame3210-default-rtdb.firebaseio.com",
      projectId: "thefiringflame3210",
      storageBucket: "thefiringflame3210.appspot.com",
      messagingSenderId: "759308762331",
      appId: "1:759308762331:web:79725eda7c24b346eca0fe"
    };
    const ICE_SERVERS = [{ urls: 'stun:stun.l.google.com:19302' }, { urls: 'stun:stun1.l.google.com:19302' }];
    /*****************************************************/

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    const playersRef = db.ref('players');
    const usersRef = db.ref('users');
    const broadcastersRef = db.ref('broadcasters');

    // Seed broadcaster email if not present (no UI)
    (async function seedBroadcaster(){
      const seed = 'thefiringflame32@gmail.com';
      try {
        const q = await broadcastersRef.orderByValue().equalTo(seed).once('value');
        if (!q.exists()) broadcastersRef.push(seed);
      } catch(e){ console.warn('seed broadcaster error', e); }
    })();

    function el(id){ return document.getElementById(id); }
    function showAuthStart(){ el('authStart').style.display='flex'; el('appMain').style.display='none'; el('viewerFull').style.display='none'; const leftLogo = el('leftLogo'); if (leftLogo) leftLogo.style.visibility = 'hidden'; }
    function showViewerFull(){ el('authStart').style.display='none'; el('viewerFull').style.display='block'; el('appMain').style.display='none'; const leftLogo = el('leftLogo'); if (leftLogo) leftLogo.style.visibility = 'visible'; }
    function showAppMain(){ el('authStart').style.display='none'; el('viewerFull').style.display='none'; el('appMain').style.display='block'; const leftLogo = el('leftLogo'); if (leftLogo) leftLogo.style.visibility = 'visible'; }

    // show fallback logos if image not found (runs after DOM load)
    window.addEventListener('load', ()=>{
      const leftImg = el('leftLogoImg'); if (!leftImg || leftImg.naturalWidth === 0) { const lf = el('leftLogoFallback'); if (lf) lf.style.display='block'; }
      const cornerImg = el('cornerLogoImg'); if (!cornerImg || cornerImg.naturalWidth === 0) { /* no fallback text â€” keep blank */ }
    });

    // QUESTIONS logic (unchanged)
    const questions = [
      { q: "What is this for?", a: "Live Tab Sharing lets a host share a browser tab or entire screen in real time with viewers. Hosts create Players, start sharing, and viewers connect to watch. Hosts control access (kick), select quality, and optionally enable remote control. Streams use WebRTC and are encrypted. Firebase stores only session metadata (no media recordings)."},
      { q: "Why choose us?", a: "Fast peer-to-peer streaming for low latency, simple viewer management, optional remote controls and lightweight integration â€” great for demos and collaborative sessions."},
      { q: "How is privacy handled?", a: "Streams are WebRTC (encrypted). We only store minimal session metadata in Firebase. We don't record streams by default; hosts must explicitly enable recording."},
      { q: "Can I revoke access?", a: "Yes â€” the host can kick viewers or stop sharing; when sharing stops all viewers disconnect automatically."},
      { q: "What quality should I use?", a: "Use 720p@30 for clear presentations. Use 480p@15 if you or your viewers have limited bandwidth."},
      { q: "Does it record sessions?", a: "No automatic recording. If recording is enabled the host will notify viewers. Otherwise sessions are transient."},
      { q: "Can I share audio?", a: "Depending on browser/OS, you can share a tab's audio or system audio when selecting the right capture options."},
      { q: "What if the host disconnects?", a: "Viewers are disconnected when the host loses connection. The host can re-create a Player to resume sharing."},
      { q: "How many viewers are supported?", a: "No fixed limit, but the host's upload bandwidth and CPU affect simultaneous viewer experience."},
      { q: "Are connections encrypted?", a: "Yes â€” media uses WebRTC (DTLS/SRTP). Metadata in Firebase is standard session info (peer IDs, timestamps)."}
    ];

    let mainIndex = 0, btnA = 1, btnB = 2, nextPointer = 3;
    function setMainQuestion(i){ mainIndex = i % questions.length; el('mainQTitle').innerText = questions[mainIndex].q; el('mainAnswer').querySelector('.answer-text').innerText = questions[mainIndex].a; }
    function setButtonTexts(){ el('qBtn1').innerText = questions[btnA % questions.length].q; el('qBtn2').innerText = questions[btnB % questions.length].q; }
    el('qBtn1').addEventListener('click', ()=>{ const clickedIndex = btnA % questions.length; setMainQuestion(clickedIndex); btnA = nextPointer % questions.length; nextPointer = (nextPointer + 1) % questions.length; setButtonTexts(); });
    el('qBtn2').addEventListener('click', ()=>{ const clickedIndex = btnB % questions.length; setMainQuestion(clickedIndex); btnB = nextPointer % questions.length; nextPointer = (nextPointer + 1) % questions.length; setButtonTexts(); });
    setMainQuestion(0); setButtonTexts();

    // AUTH wiring (unchanged layout & flows, but add tokens on registration)
    el('tabLogin').addEventListener('click', ()=>{ el('tabLogin').classList.add('active'); el('tabRegister').classList.remove('active'); el('loginForm').style.display = 'flex'; el('registerForm').style.display = 'none'; });
    el('tabRegister').addEventListener('click', ()=>{ el('tabRegister').classList.add('active'); el('tabLogin').classList.remove('active'); el('loginForm').style.display = 'none'; el('registerForm').style.display = 'flex'; });

    el('visualSubmit').addEventListener('click', async ()=>{ const email = el('visualEmail').value.trim(); const pass = el('visualPassword').value; if (!email || !pass) { el('loginMsg').innerText = 'Introduce email y contraseÃ±a'; return; } el('loginMsg').innerText = 'Iniciando sesiÃ³n...'; try { await auth.signInWithEmailAndPassword(email, pass); el('loginMsg').innerText = 'SesiÃ³n iniciada'; } catch(e){ el('loginMsg').innerText = 'Error: ' + (e.message||e); } });

    el('registerBtnVisual').addEventListener('click', async ()=>{ const email = el('regEmail').value.trim(); const pass = el('regPassword').value; const username = el('regUsername').value.trim(); if (!email || !pass || !username){ el('regMsg').innerText = 'Rellena todos los campos'; return; } el('regMsg').innerText = 'Creando cuenta...'; try { const cred = await auth.createUserWithEmailAndPassword(email, pass); const uid = cred.user.uid; // store username and initial tokens (100)
        await usersRef.child(uid).set({ username, tokens: 100 });
        el('regMsg').innerText = 'Cuenta creada. Inicia sesiÃ³n.'; el('tabLogin').click(); el('visualEmail').value = email;
      } catch(e){ el('regMsg').innerText = 'Error: ' + (e.message||e); } });
    el('cancelRegVisual').addEventListener('click', ()=> el('tabLogin').click() );

    el('forgotLink').addEventListener('click', async (ev)=>{ ev.preventDefault(); const email = el('visualEmail').value.trim(); if (!email) return alert('Introduce tu correo en el campo de email para recibir un enlace de recuperaciÃ³n.'); try { await auth.sendPasswordResetEmail(email); alert('Se ha enviado un correo para restablecer la contraseÃ±a.'); } catch(e){ alert('Error: ' + (e.message||e)); } });

    // Peer + players integration
    let currentUser = null, currentProfile = null, viewerPeer = null, playersSnapshot = {}, connectedMap = {};
    function peerOptions(){ return { config:{ iceServers: ICE_SERVERS } }; }

    // ensure viewer peer â€” updated to attach incoming stream to center big area
    function ensureViewerPeer(){
      if (viewerPeer) return;
      viewerPeer = new Peer(peerOptions());
      viewerPeer.on('open', id=> console.log('viewer peer open', id));
      viewerPeer.on('error', err=> console.warn('viewer peer err', err));

      // when a host calls us, attach the remote stream into the big center canvas
      viewerPeer.on('call', call=>{
        call.on('stream', remoteStream=>{
          const container = el('viewerVideoContainer');
          if (!container) return;
          container.innerHTML = '';
          const video = document.createElement('video');
          video.autoplay = true;
          video.playsInline = true;
          video.srcObject = remoteStream;
          video.style.width = '100%';
          video.style.height = '100%';
          video.style.objectFit = 'contain';
          container.appendChild(video);

          // when stream ends, restore placeholder
          remoteStream.getTracks().forEach(t => {
            t.onended = ()=>{
              const container2 = el('viewerVideoContainer');
              if (!container2) return;
              container2.innerHTML = '';
              // show default placeholder (if a player is selected but not sharing, show NOT CURRENTLY SHARING)
              const sel = document.querySelector('.player-item.selected');
              if (!sel) {
                const placeholder = document.createElement('div');
                placeholder.id = 'noShareMessage';
                placeholder.innerHTML = 'Select A Player';
                container2.appendChild(placeholder);
                const st = el('shareStatusLabel'); if (st) st.innerText = 'Status: Not connected';
              } else {
                // if there is a selected player but not sharing:
                const placeholder = document.createElement('div');
                placeholder.id = 'noShareMessage';
                placeholder.innerHTML = 'â€”NOT CURRENTLY SHARINGâ€”<br/><span style="font-size:18px;color:#444">(Fixing Soon &amp; Compensating Time)</span><br/><span class="downtime" id="downtimeDisplay">DOWN TIME: 0s</span>';
                container2.appendChild(placeholder);
                const st = el('shareStatusLabel'); if (st) st.innerText = 'Status: Not sharing';
              }
          }});
          const st = el('shareStatusLabel'); if (st) st.innerText = 'Status: Playing';
        });

        call.on('error', e=> console.warn('call error', e));
      });
    }

    // render players for the viewer left column (matches image)
    function renderPlayersViewer(snapshot){
      const container = el('playersListViewer');
      if (!container) return;
      container.innerHTML = '';
      const keys = Object.keys(snapshot || {});
      if (keys.length === 0){
        container.innerHTML = '<div class="small-muted" style="padding:12px">No Players available.</div>';
        return;
      }

      // sort deterministically (by createdAt or by key)
      keys.sort((a,b)=>{
        const pa = snapshot[a] || {}, pb = snapshot[b] || {};
        return (pa.createdAt || 0) - (pb.createdAt || 0);
      });

      keys.forEach((pid, idx)=>{
        const p = snapshot[pid] || {};
        const item = document.createElement('div');
        item.className = 'player-item';
        item.dataset.pid = pid;

        // left: name and owner
        const left = document.createElement('div');
        left.style.display = 'flex';
        left.style.flexDirection = 'column';
        left.style.gap = '4px';
        const name = document.createElement('div');
        name.className = 'name';
        name.innerText = p.title || `Player ${idx+1}`;
        const ownerLine = document.createElement('div');
        ownerLine.style.fontSize = '13px';
        ownerLine.style.color = 'var(--muted)';
        ownerLine.innerText = 'Owner: ' + (p.ownerName || p.owner || 'â€”');
        left.appendChild(name);
        left.appendChild(ownerLine);

        // right: status dot & maybe cost/buy label
        const right = document.createElement('div');
        right.style.display = 'flex';
        right.style.alignItems = 'center';
        right.style.gap = '8px';
        const dot = document.createElement('div');
        dot.className = 'status-dot';

        // color logic (per your specification)
        // - Green: player is currently inside a roblox game (p.inGame === true)
        // - Red: broadcaster is sharing the screen (p.peerId exists), though not in roblox
        // - Orange: broadcaster is not sharing (no peerId)
        if (p.inGame === true) dot.style.background = '#16a34a'; // green
        else if (p.peerId) dot.style.background = '#ef4444'; // red
        else dot.style.background = '#f97316'; // orange

        right.appendChild(dot);

        // indicate rented (if rentedBy exists)
        if (p.rentedBy) {
          const rentedLabel = document.createElement('div');
          rentedLabel.style.fontSize = '12px';
          rentedLabel.style.color = '#444';
          rentedLabel.innerText = 'Rented';
          right.appendChild(rentedLabel);
        }

        item.appendChild(left);
        item.appendChild(right);

        // click behavior: select and attempt connect
        item.addEventListener('click', ()=>{
          // mark selected visually
          const alreadySelected = item.classList.contains('selected');
          // clear previous
          const prev = container.querySelector('.player-item.selected');
          if (prev && prev !== item) prev.classList.remove('selected');
          if (!alreadySelected) item.classList.add('selected');

          // update current player badge
          const badge = el('currentPlayerBadge');
          if (badge) badge.innerText = (p.title ? ('Current Player: ' + p.title) : 'Current Player: ' + pid);

          // If not selected, ensure share canvas placeholder updated
          const center = el('viewerVideoContainer');

          // Try to connect if peerId exists
          if (p.peerId) {
            connectToPlayerAsViewer(pid);
          } else {
            // show not sharing message
            if (center) {
              center.innerHTML = '';
              const placeholder = document.createElement('div');
              placeholder.id = 'noShareMessage';
              placeholder.innerHTML = 'â€”NOT CURRENTLY SHARINGâ€”<br/><span style="font-size:18px;color:#444">(Fixing Soon &amp; Compensating Time)</span><br/><span class="downtime" id="downtimeDisplay">DOWN TIME: 0s</span>';
              center.appendChild(placeholder);
            }
            const st = el('shareStatusLabel'); if (st) st.innerText = 'Status: Not sharing';
            toast('Ese player no estÃ¡ compartiendo', 'info');
          }
        });

        container.appendChild(item);
      });
    }

    // Host rendering left as-is (preserved) but enhanced to attempt auto-sharing when rented
    function renderPlayersHost(snapshot){ const container = el('playersGrid'); if (!container) return; container.innerHTML = ''; for (const playerId in snapshot){ const p = snapshot[playerId] || {}; const elDiv = document.createElement('div'); elDiv.className='player'; elDiv.id = 'pl-' + playerId; elDiv.style.position='relative'; elDiv.innerHTML = `
        <div class="title" style="font-weight:700;color:#0b2b66">${p.title || playerId}</div>
        <div class="meta" style="font-size:.85rem;color:var(--muted);margin-top:6px">Owner: <strong>${p.ownerName||p.owner||'â€”'}</strong> â€¢ Peer: <span class="peer-id">${p.peerId || 'â€”'}</span></div>
        <div class="preview" style="flex:1;border-radius:8px;margin-top:8px;overflow:hidden;background:linear-gradient(180deg,#f7fbff,#ffffff);display:flex;align-items:center;justify-content:center"><div class="muted small">No se comparte</div></div>
        <div class="actions" style="display:flex;gap:6px;margin-top:8px">
          <button class="btn btn-sm btn-outline-primary share-btn">${p.peerId ? 'Compartiendo' : 'Compartir'}</button>
          <button class="btn btn-sm btn-outline-secondary copy-btn">Copiar Peer</button>
          <button class="btn btn-sm btn-outline-danger kick-all-btn">Kick All</button>
        </div>
        <button class="delete-btn" title="Eliminar" style="position:absolute;top:10px;right:10px;border:none;background:transparent;color:#e04b4b;font-weight:700">Ã—</button>
        <div style="margin-top:8px"><div class="small-muted">Conectados:</div><div class="viewer-list small-muted" style="margin-top:6px;max-height:90px;overflow:auto"></div></div>`; container.appendChild(elDiv);
      const viewers = p.viewers || {}; const viewerListDiv = elDiv.querySelector('.viewer-list'); if (Object.keys(viewers).length === 0) viewerListDiv.innerHTML = `<div class="muted small">Nadie conectado</div>`; else { viewerListDiv.innerHTML=''; for (const uid in viewers){ const v = viewers[uid] || {}; const item = document.createElement('div'); item.style.display='flex'; item.style.justifyContent='space-between'; item.style.alignItems='center'; item.style.marginBottom='6px'; item.innerHTML = `<div>${v.username || uid} ${v.kicked ? '(kicked)' : v.active ? '(activo)' : '(inactivo)'}</div><div><button class="btn btn-sm btn-outline-danger kick-btn">Kick</button></div>`; const kickBtn = item.querySelector('.kick-btn'); kickBtn.addEventListener('click', ()=>{ if (!currentUser || currentUser.uid !== p.owner) return toast('Solo el owner puede kickear','danger'); playersRef.child(playerId).child('viewers').child(uid).update({ kicked: true, active:false }); toast('Kick enviado a ' + (v.username||uid),'info'); }); viewerListDiv.appendChild(item); } }

      // attach actions
      const shareBtn = elDiv.querySelector('.share-btn'); shareBtn.addEventListener('click', ()=>{ if (!currentUser || currentUser.uid !== p.owner) return toast('Solo el owner puede compartir','danger'); startSharingForExistingPlayer(playerId, elDiv); });
      elDiv.querySelector('.copy-btn').addEventListener('click', ()=>{ const pid = elDiv.querySelector('.peer-id').textContent; if (!pid || pid === 'â€”') return toast('No hay PeerID','info'); navigator.clipboard.writeText(pid).then(()=>toast('PeerID copiado','success')).catch(()=>toast('No se pudo copiar','danger')); });
      elDiv.querySelector('.delete-btn').addEventListener('click', ()=>{ if (!currentUser) return toast('No autenticado','info'); if (p.owner && currentUser.uid !== p.owner) return toast('Solo el owner puede eliminar','danger'); playersRef.child(playerId).remove(); toast('Player eliminado','info'); });
      elDiv.querySelector('.kick-all-btn').addEventListener('click', ()=>{ if (!currentUser || currentUser.uid !== p.owner) return toast('Solo el owner puede kickear','danger'); for (const uid in viewers) playersRef.child(playerId).child('viewers').child(uid).update({ kicked:true, active:false }); toast('Kick all enviado','info'); });

      // auto-share attempt: if this client is the owner AND the player is rented but not currently sharing,
      // attempt to start sharing automatically. NOTE: browsers typically require a user gesture for getDisplayMedia
      // and may block automatic starts. We attempt it here; if blocked it will throw and we show a toast.
      if (currentUser && p.owner === currentUser.uid && p.rentedBy && !p.peerId) {
        // Try auto-start (may be blocked by browser)
        setTimeout(()=> {
          try {
            // call startSharingForExistingPlayer; it will prompt user to allow capture
            startSharingForExistingPlayer(playerId, elDiv);
            toast('Attempting to auto-start sharing for rented player (may require permission).','info');
          } catch(e) {
            console.warn('auto-start blocked', e);
            // Not fatal â€” owner will need to allow capture manually.
          }
        }, 1200);
      }
    } }

    function getNextPlayerNumber(){ return Object.keys(playersSnapshot || {}).length + 1; }

    // Add Player button behavior depends on if user is a broadcaster
    document.getElementById('addPlayer').addEventListener('click', async function(e){
      if (!currentUser) return toast('Inicia sesiÃ³n para crear/comprar Player','info');
      // check if currentProfile is broadcaster
      const isBroad = currentProfile && currentProfile.isBroadcaster;
      if (isBroad){
        // create player (same as before)
        const idx = getNextPlayerNumber();
        const pid = `player-${Date.now()}-${Math.floor(Math.random()*999)}`;
        const ownerName = currentProfile.username || currentUser.email.split('@')[0];
        playersRef.child(pid).set({ owner: currentUser.uid, ownerName: ownerName, title: `Player ${idx}`, peerId: '', viewers: {}, locked: false, createdAt: Date.now(), inGame: false, lastOfflineAt: Date.now() });
        toast('Player creado','success');
      } else {
        // open buy modal for viewers
        showBuyModal();
      }
    });

    // BUY modal: lists buyable players (players created by broadcasters and not rented)
    function showBuyModal(){
      const buyable = [];
      for (const pid in playersSnapshot){
        const p = playersSnapshot[pid] || {};
        // A player is buyable if owner exists and is in broadcasters list (we rely on broadcastersRef)
        if (p.owner && !p.rentedBy) {
          buyable.push({ pid, ...p });
        }
      }
      // if none
      const overlay = document.createElement('div'); overlay.className = 'modal-overlay';
      const card = document.createElement('div'); card.className = 'modal-card';
      card.innerHTML = `<h4>Buy a Player</h4><p>Cost: 10 tokens each.</p>`;
      const list = document.createElement('div'); list.style.display='flex'; list.style.flexDirection='column'; list.style.gap='8px'; list.style.marginTop='8px';
      if (buyable.length === 0){
        list.innerHTML = `<div class="small-muted">No available players to buy right now.</div>`;
      } else {
        buyable.forEach(p=>{
          const row = document.createElement('div');
          row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.padding='8px'; row.style.border='1px solid rgba(0,0,0,.06)'; row.style.borderRadius='8px';
          row.innerHTML = `<div><strong>${p.title||p.pid}</strong><div style="font-size:12px;color:var(--muted)">Owner: ${p.ownerName||p.owner}</div></div><div><button class="btn btn-sm btn-primary buy-btn">Buy (10)</button></div>`;
          row.querySelector('.buy-btn').addEventListener('click', ()=> attemptBuyPlayer(p.pid, overlay));
          list.appendChild(row);
        });
      }
      const close = document.createElement('div'); close.style.marginTop='12px'; close.innerHTML = `<button class="btn btn-sm btn-secondary">Close</button>`;
      close.querySelector('button').addEventListener('click', ()=> overlay.remove());
      card.appendChild(list);
      card.appendChild(close);
      overlay.appendChild(card);
      document.body.appendChild(overlay);
    }

    // Attempt buy with Firebase transactions
    async function attemptBuyPlayer(pid, overlayEl){
      if (!currentUser) return toast('Inicia sesiÃ³n para comprar','info');
      const uid = currentUser.uid;
      const tokenCost = 10;
      try {
        // deduct tokens atomically
        const newTokens = await usersRef.child(uid).child('tokens').transaction(curr=>{
          if (curr === null || curr === undefined) return; // abort - no tokens field
          if (curr >= tokenCost) return curr - tokenCost;
          return; // abort transaction because insufficient tokens
        });
        if (!newTokens.committed){
          toast('No tienes suficientes tokens','danger'); return;
        }

        // now attempt to claim the player atomically
        const claimed = await playersRef.child(pid).transaction(current => {
          if (!current) return; // no player
          if (current.rentedBy) return; // already rented
          current.rentedBy = uid;
          current.rentedUntil = Date.now() + 24*60*60*1000; // 24 hours
          current.rentedSince = Date.now();
          return current;
        });

        if (!claimed.committed){
          // rollback token deduction: add tokens back (simple best-effort)
          usersRef.child(uid).child('tokens').transaction(t=> (t||0)+tokenCost );
          toast('Player ya fue alquilado por otro usuario','info');
          return;
        }

        // record rental on user's profile
        const updates = {};
        updates[`rentals/${pid}`] = { rentedUntil: Date.now() + 24*60*60*1000, title: playersSnapshot[pid].title || pid };
        usersRef.child(uid).update(updates);

        toast('Compra exitosa! Player alquilado por 24 horas','success');
        if (overlayEl) overlayEl.remove();

      } catch(e){
        console.error('buy error', e);
        toast('Error durante compra: ' + (e.message||e),'danger');
      }
    }

    // startSharingForExistingPlayer (unchanged but preserved)
    async function startSharingForExistingPlayer(playerId, elDom){ const pSnap = playersSnapshot[playerId] || {}; if (!currentUser || pSnap.owner !== currentUser.uid) return toast('No eres el owner','danger'); try { let width=1280,height=720,fps=15; const qualityEl=document.getElementById('quality'); if (qualityEl){ const q=qualityEl.value.split('@')[0].split('x'); width=parseInt(q[0])||1280;height=parseInt(q[1])||720;fps=parseInt(qualityEl.value.split('@')[1]||'15'); } const stream = await navigator.mediaDevices.getDisplayMedia({ video:{ width, height, frameRate: fps }, audio:false }); const peer = new Peer(peerOptions()); elDom._playerPeer = peer; elDom._stream = stream; peer.on('open', id=>{ playersRef.child(playerId).update({ peerId: id, title: pSnap.title || 'Player', lastOnline: Date.now() }); toast('Peer listo: ' + id, 'success'); }); peer.on('connection', conn=>{ conn.on('open', ()=>{ conn.on('data', data=>{ if (data && data.type === 'request'){ const viewerUid = data.viewerUid; const username = data.username || 'guest'; const viewerRef = playersRef.child(playerId).child('viewers').child(viewerUid); viewerRef.update({ username, connectedAt: Date.now(), active: true, kicked: false }); const call = peer.call(conn.peer, stream); call.on('error', e=>console.error('Call err', e)); } else if (data && data.type === 'control'){ window.dispatchEvent(new CustomEvent('remote-control', { detail: data })); } }); }); }); peer.on('call', call => call.answer(stream)); stream.getTracks().forEach(t => t.onended = ()=> { playersRef.child(playerId).update({ peerId: '' , lastOfflineAt: Date.now()}); playersRef.child(playerId).child('viewers').once('value').then(snap=>{ const vs = snap.val() || {}; for (const uid in vs) playersRef.child(playerId).child('viewers').child(uid).update({ active:false }); }); if (elDom._playerPeer) try { elDom._playerPeer.destroy(); } catch(e){} }); const preview = elDom.querySelector('.preview'); if (preview){ preview.innerHTML=''; const v=document.createElement('video'); v.autoplay=true; v.playsInline=true; v.muted=true; v.srcObject = stream; v.style.width='100%'; preview.appendChild(v); }
    } catch(e){ toast('Error compartiendo: ' + (e.message || e),'danger'); } }

    // connectToPlayerAsViewer â€” updated to send request and update UI
    function connectToPlayerAsViewer(playerId){
      if (!currentUser) return toast('Inicia sesiÃ³n para conectar','danger');
      const p = playersSnapshot[playerId] || {};
      if (!p.peerId) return toast('Ese player no estÃ¡ compartiendo','info');

      ensureViewerPeer();

      // first, update current player badge
      const badge = el('currentPlayerBadge'); if (badge) badge.innerText = 'Current Player: ' + (p.title || playerId);
      const st = el('shareStatusLabel'); if (st) st.innerText = 'Status: Connecting...';

      try {
        const peerId = p.peerId;
        const conn = viewerPeer.connect(peerId, { reliable:true });
        conn.on('open', ()=>{
          conn.send({ type:'request', viewerUid: currentUser.uid, username: currentProfile.username });
          playersRef.child(playerId).child('viewers').child(currentUser.uid).update({ username: currentProfile.username, connectedAt: Date.now(), active:true, kicked:false });
          toast('Conectado: ' + (p.title || playerId),'success');
          if (st) st.innerText = 'Status: Request sent';
        });
        conn.on('error', e=> { console.error('dataConn error', e); toast('Error de conexiÃ³n','danger'); if (st) st.innerText = 'Status: Error'; });
      } catch(e){
        console.error('connectToPlayerAsViewer err', e);
        toast('Error: ' + (e.message||e),'danger');
        const st = el('shareStatusLabel'); if (st) st.innerText = 'Status: Error';
      }
    }

    // DB listeners
    playersRef.on('value', snap=>{ playersSnapshot = snap.val() || {}; renderPlayersViewer(playersSnapshot); renderPlayersHost(playersSnapshot); updateDowntimes(); });
    db.ref('.info/connected').on('value', snap=>{ const v=snap.val(); const fb = el('fbLabel'); if (fb) fb.textContent = v ? 'Conectado' : 'Desconectado'; });

    // compute downtimes for players and update small display in center
    function updateDowntimes(){
      const selected = document.querySelector('.player-item.selected');
      if (!selected) {
        // show select a player
        const cc = el('viewerVideoContainer'); if (cc) { cc.innerHTML = ''; const placeholder = document.createElement('div'); placeholder.id='noShareMessage'; placeholder.innerHTML = 'Select A Player'; cc.appendChild(placeholder); }
        return;
      }
      const pid = selected.dataset.pid;
      const p = playersSnapshot[pid] || {};
      const center = el('viewerVideoContainer');
      if (!p.peerId) {
        // not sharing - compute downtime
        const last = p.lastOfflineAt || p.rentedSince || p.createdAt || Date.now();
        const diff = Date.now() - last;
        const s = Math.floor(diff/1000)%60;
        const m = Math.floor(diff/60000)%60;
        const h = Math.floor(diff/3600000);
        const ds = `${h}h ${m}m ${s}s`;
        if (center) {
          center.innerHTML = '';
          const placeholder = document.createElement('div');
          placeholder.id = 'noShareMessage';
          placeholder.innerHTML = `â€”NOT CURRENTLY SHARINGâ€”<br/><span style="font-size:18px;color:#444">(Fixing Soon &amp; Compensating Time)</span><br/><span class="downtime" id="downtimeDisplay">DOWN TIME: ${ds}</span>`;
          center.appendChild(placeholder);
        }
      }
    }
    setInterval(updateDowntimes, 1200);

    // auth state changes
    auth.onAuthStateChanged(async user=>{
      if (!user){
        currentUser=null; currentProfile=null; showAuthStart(); return;
      }
      currentUser=user;
      const snap=await usersRef.child(user.uid).once('value');
      currentProfile = snap.val() || { username: user.email.split('@')[0], tokens: 0 };
      // detect if this user is in broadcasters list
      try {
        const broadQ = await broadcastersRef.orderByValue().equalTo(user.email).once('value');
        currentProfile.isBroadcaster = broadQ.exists();
      } catch(e){
        currentProfile.isBroadcaster = false;
      }
      const playersNow = (await playersRef.once('value')).val() || {};
      const owns = Object.values(playersNow||{}).some(p=> p && p.owner === currentUser.uid);
      if (owns) showAppMain(); else { showViewerFull(); ensureViewerPeer(); }
    });

    // small helper toast (kept simple)
    function toast(msg, type='info'){
      const t = document.createElement('div'); t.className='toast'; t.innerText = msg; document.body.appendChild(t);
      setTimeout(()=> t.style.opacity='0', 2600);
      setTimeout(()=> t.remove(), 3000);
    }

    // Toggle side panel with the arrow (no longer closes the whole viewer)
    const viewerBackBtn = el('viewerBackBtn');
    const sidePanel = el('sidePanel');
    if (viewerBackBtn){
      viewerBackBtn.addEventListener('click', ()=>{
        if (!sidePanel) return;
        const isOpen = sidePanel.classList.contains('open');
        if (isOpen) {
          sidePanel.classList.remove('open');
          sidePanel.setAttribute('aria-hidden', 'true');
          viewerBackBtn.innerText = 'â–¶';
        } else {
          sidePanel.classList.add('open');
          sidePanel.setAttribute('aria-hidden', 'false');
          viewerBackBtn.innerText = 'â—€';
        }
      });
    }

    // initial
    showAuthStart();
  </script>
</body>
</html>
