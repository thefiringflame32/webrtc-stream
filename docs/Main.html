<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Live Tab Sharing — Mejorado</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/4.5.2/flatly/bootstrap.min.css"/>
  <style>
    :root{
      --card-radius:12px;
      --muted:#6c757d;
      --accent:#2563eb;
    }
    body{background:linear-gradient(180deg,#f0f6ff 0%, #f8fafc 100%);font-family:Inter,Segoe UI,Roboto, system-ui, sans-serif;margin:0;padding:18px}
    .app{max-width:1200px;margin:0 auto}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    .logo{display:flex;align-items:center;gap:12px}
    .brand-logo{width:46px;height:46px;border-radius:10px;background:#fff;display:flex;align-items:center;justify-content:center;color:var(--accent);font-weight:800;box-shadow:0 8px 22px rgba(30,60,120,.06)}
    .muted{color:var(--muted)}
    .grid{display:grid;grid-template-columns:1fr 320px;gap:14px}
    .main-card{border-radius:var(--card-radius);padding:14px;background:#fff;box-shadow:0 10px 30px rgba(28,41,77,.04)}
    .controls{display:flex;gap:8px;align-items:center;margin-bottom:12px}
    #playersGrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px}
    .player{background:linear-gradient(180deg,#ffffff,#fbfdff);border-radius:10px;padding:10px;border:1px solid rgba(30,41,55,.06);position:relative;min-height:160px;display:flex;flex-direction:column}
    .player .title{font-weight:700;color:#0b2b66}
    .player .meta{font-size:.85rem;color:var(--muted);margin-top:6px}
    .preview{flex:1;border-radius:8px;margin-top:8px;overflow:hidden;background:linear-gradient(180deg,#f7fbff,#ffffff);display:flex;align-items:center;justify-content:center}
    .preview video{width:100%;height:100%;object-fit:cover}
    .player .actions{display:flex;gap:6px;margin-top:8px}
    .badge-status{position:absolute;top:10px;left:10px;font-size:.72rem}
    .delete-btn{position:absolute;top:10px;right:10px;border:none;background:transparent;color:#e04b4b;font-weight:700}
    .side{display:flex;flex-direction:column;gap:12px}
    .side .card{padding:12px;border-radius:10px}
    .connected-list{max-height:360px;overflow:auto}
    .viewer-chip{display:flex;justify-content:space-between;align-items:center;padding:6px;border-radius:6px;background:#f4f7fb;margin-bottom:6px}
    .small-muted{font-size:.85rem;color:var(--muted)}
    .help-panel{display:none}
    .register-panel{display:none}
    .user-pill{background:#fff;padding:6px 8px;border-radius:999px;border:1px solid rgba(30,41,55,.06)}
    .connected-side{display:flex;flex-direction:column;gap:10px}
    @media(max-width:980px){ .grid{grid-template-columns:1fr} .side{order:2} }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="logo">
        <div class="brand-logo">LTS</div>
        <div>
          <div style="font-weight:800;font-size:1.05rem">Live Tab Sharing</div>
          <div class="muted small-muted">Compartir pantallas — control opcional</div>
        </div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <div id="userBadge" class="user-pill">No autenticado</div>
        <button id="helpBtn" class="btn btn-outline-secondary btn-sm">Help</button>
        <button id="toggleRegisterBtn" class="btn btn-outline-primary btn-sm">Crear cuenta</button>
        <button id="logoutBtn" class="btn btn-outline-danger btn-sm" style="display:none">Cerrar sesión</button>
      </div>
    </header>

    <div class="grid">
      <!-- Main column -->
      <div class="main-card">
        <!-- Auth area (login visible by default) -->
        <div id="authArea" style="margin-bottom:12px">
          <div id="loginPanel">
            <div class="row">
              <div class="col-sm-6">
                <input id="loginEmail" class="form-control mb-2" placeholder="Correo" type="email" />
              </div>
              <div class="col-sm-6">
                <input id="loginPassword" class="form-control mb-2" placeholder="Contraseña" type="password" />
              </div>
            </div>
            <div style="display:flex;gap:8px">
              <button id="loginBtn" class="btn btn-primary">Iniciar sesión</button>
              <button id="emailLinkBtn" class="btn btn-outline-warning">Enviar enlace</button>
              <div id="authMsg" class="muted small" style="align-self:center;margin-left:8px"></div>
            </div>
          </div>

          <div id="registerPanel" class="register-panel mt-2">
            <div class="card" style="padding:10px;border-radius:10px">
              <h6>Crear cuenta</h6>
              <input id="regEmail" class="form-control mb-2" placeholder="Correo" type="email" />
              <input id="regPassword" class="form-control mb-2" placeholder="Contraseña" type="password" />
              <input id="regUsername" class="form-control mb-2" placeholder="Nombre (username público)" type="text" />
              <div style="display:flex;gap:8px">
                <button id="registerBtn" class="btn btn-success">Registrarme</button>
                <button id="cancelRegisterBtn" class="btn btn-light">Cancelar</button>
              </div>
            </div>
          </div>
        </div>

        <div class="controls" style="justify-content:space-between;align-items:center">
          <div style="display:flex;gap:8px;align-items:center">
            <button id="addPlayer" class="btn btn-outline-primary btn-sm">Agregar Player</button>
            <label class="muted small">Calidad</label>
            <select id="quality" class="form-control form-control-sm" style="width:160px">
              <option value="1280x720@30">720p@30</option>
              <option value="1280x720@15">720p@15</option>
              <option value="854x480@15">480p@15</option>
            </select>
            <button id="refreshBtn" class="btn btn-outline-info btn-sm">Refrescar</button>
          </div>
          <div class="small-muted">Players: <span id="playersCount">0</span></div>
        </div>

        <div id="playersGrid"></div>
      </div>

      <!-- Side column -->
      <div class="side">
        <div class="card help-panel" id="helpPanel">
          <h6>Ayuda rápida</h6>
          <p class="muted small">Inicia sesión, crea un Player como host y comparte la pantalla. Los viewers conectan y pueden enviar controles opcionales. El host puede ver y kickear viewers.</p>
        </div>

        <div class="card" id="connectedPanel">
          <h6>Conexiones activas</h6>
          <div class="connected-list" id="connectedList">
            <div class="muted small">No estás conectado a ningún Player.</div>
          </div>
        </div>

        <div class="card">
          <h6>Estado</h6>
          <div class="small-muted">PeerJS: <span id="peerLabel">Cloud</span></div>
          <div class="small-muted">Firebase: <span id="fbLabel">Desconocido</span></div>
        </div>
      </div>
    </div>

    <div id="toastWrap" style="position:fixed;right:18px;bottom:18px;z-index:2000"></div>
  </div>

  <!-- Firebase & PeerJS -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/peerjs@1.4.7/dist/peerjs.min.js"></script>

  <script>
  /*********************** CONFIG - reemplaza si hace falta ***********************/
  const firebaseConfig = {
    apiKey: "AIzaSyDLQGyXjRwrJ9O6RbVFtp-4uRNepAWdfrU",
    authDomain: "thefiringflame3210.firebaseapp.com",
    databaseURL: "https://thefiringflame3210-default-rtdb.firebaseio.com",
    projectId: "thefiringflame3210",
    storageBucket: "thefiringflame3210.appspot.com",
    messagingSenderId: "759308762331",
    appId: "1:759308762331:web:79725eda7c24b346eca0fe"
  };
  const PEERJS_USE_CLOUD = true;
  const ICE_SERVERS = [{ urls: 'stun:stun.l.google.com:19302' }, { urls: 'stun:stun1.l.google.com:19302' }];
  /**************************************************************************/

  // Firebase init
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();
  const playersRef = db.ref('players');
  const usersRef = db.ref('users');

  // Peer factory
  function peerOptions(){ return { config: { iceServers: ICE_SERVERS } }; }

  // UI helpers
  function toast(msg, type='info'){
    const wrap = document.getElementById('toastWrap');
    const div = document.createElement('div');
    div.className = `alert alert-${type} alert-dismissible fade show`;
    div.style.minWidth = '220px';
    div.innerHTML = msg + `<button type="button" class="close" data-dismiss="alert">&times;</button>`;
    wrap.appendChild(div);
    setTimeout(()=>{ try{ div.remove(); }catch(e){} }, 4500);
  }

  // State
  let currentUser = null;             // Firebase user (auth)
  let currentProfile = null;          // { username }
  let broadcasterPlayers = [];        // list of player numbers
  let peerIdToPlayer = {};            // mapping peerId -> playerId (keeps updated)
  let viewerPeer = null;              // single Peer instance for viewer side
  let connectedMap = {};              // playerId -> { dataConn, call, videoEl, peerId }

  // Keep a live snapshot of players (for mapping peerId->player)
  let playersSnapshot = {};

  // ---------- UI wiring ----------
  const helpBtn = document.getElementById('helpBtn');
  const helpPanel = document.getElementById('helpPanel');
  const toggleRegisterBtn = document.getElementById('toggleRegisterBtn');
  const registerPanel = document.getElementById('registerPanel');
  const loginPanel = document.getElementById('loginPanel');
  const logoutBtn = document.getElementById('logoutBtn');

  helpBtn.addEventListener('click', ()=> {
    helpPanel.style.display = helpPanel.style.display === 'block' ? 'none' : 'block';
  });

  toggleRegisterBtn.addEventListener('click', ()=> {
    // Show register, hide login
    registerPanel.style.display = registerPanel.style.display === 'block' ? 'none' : 'block';
    loginPanel.style.display = registerPanel.style.display === 'block' ? 'none' : 'block';
  });
  document.getElementById('cancelRegisterBtn').addEventListener('click', ()=>{
    registerPanel.style.display = 'none';
    loginPanel.style.display = 'block';
  });

  // Auth actions
  document.getElementById('loginBtn').addEventListener('click', async ()=>{
    const email = document.getElementById('loginEmail').value.trim();
    const pass = document.getElementById('loginPassword').value;
    try {
      await auth.signInWithEmailAndPassword(email, pass);
      toast('Sesión iniciada','success');
    } catch(e){ toast('Login: '+(e.message||e),'danger') }
  });

  document.getElementById('emailLinkBtn').addEventListener('click', async ()=>{
    const email = document.getElementById('loginEmail').value.trim();
    if (!email) return toast('Introduce un correo','info');
    try {
      const actionCodeSettings = { url: window.location.href, handleCodeInApp: true };
      await auth.sendSignInLinkToEmail(email, actionCodeSettings);
      window.localStorage.setItem('emailForSignIn', email);
      toast('Enlace enviado','success');
    } catch(e){ toast('Error: '+(e.message||e),'danger') }
  });

  document.getElementById('registerBtn').addEventListener('click', async ()=>{
    const email = document.getElementById('regEmail').value.trim();
    const pass = document.getElementById('regPassword').value;
    const username = document.getElementById('regUsername').value.trim();
    if (!email || !pass || !username) return toast('Rellena todos los campos','info');
    try {
      const cred = await auth.createUserWithEmailAndPassword(email, pass);
      const uid = cred.user.uid;
      // store username profile
      await usersRef.child(uid).set({ username });
      toast('Cuenta creada','success');
      registerPanel.style.display = 'none';
      loginPanel.style.display = 'block';
    } catch(e){ toast('Registro: '+(e.message||e),'danger') }
  });

  logoutBtn.addEventListener('click', ()=> auth.signOut());

  // ---------- Auth state handling ----------
  auth.onAuthStateChanged(async user=>{
    if (!user) {
      currentUser = null; currentProfile = null;
      document.getElementById('userBadge').textContent = 'No autenticado';
      logoutBtn.style.display = 'none';
      document.getElementById('playersGrid').innerHTML = '';
      playersSnapshot = {};
      document.getElementById('fbLabel').textContent = 'Desconectado';
      return;
    }
    currentUser = user;
    logoutBtn.style.display = 'inline-block';
    // load profile (username)
    const snap = await usersRef.child(user.uid).once('value');
    currentProfile = snap.val() || { username: user.email.split('@')[0] };
    document.getElementById('userBadge').textContent = currentProfile.username;
    document.getElementById('fbLabel').textContent = 'Conectado';
    // initialize UI role-aware
    initAppForUser();
  });

  // ---------- App initialization ----------
  function initAppForUser(){
    // load players list & keep snapshot
    playersRef.off(); // remove previous listeners to avoid duplicate
    playersRef.on('value', snap=>{
      playersSnapshot = snap.val() || {};
      // rebuild player UI
      renderPlayers(playersSnapshot);
      // update mapping peerId->playerId
      peerIdToPlayer = {};
      for (const pid in playersSnapshot){
        const p = playersSnapshot[pid] || {};
        if (p.peerId) peerIdToPlayer[p.peerId] = pid;
      }
      document.getElementById('playersCount').textContent = Object.keys(playersSnapshot).length;
    });

    // start viewerPeer if null
    if (!viewerPeer){
      viewerPeer = new Peer(peerOptions());
      viewerPeer.on('open', id=> console.log('Viewer peer open', id));
      viewerPeer.on('error', err=> toast('Peer error: '+(err.message||err),'danger'));
      viewerPeer.on('call', call => {
        // When a remote stream arrives, find player by call.peer using latest snapshot
        const remotePeerId = call.peer;
        const playerId = peerIdToPlayer[remotePeerId];
        call.on('stream', remoteStream => {
          // attach stream to connectedMap for that player
          if (playerId && connectedMap[playerId]) {
            const container = connectedMap[playerId].container;
            container.innerHTML = '';
            const video = document.createElement('video');
            video.autoplay = true; video.playsInline = true;
            video.srcObject = remoteStream;
            container.appendChild(video);
            connectedMap[playerId].call = call;
            connectedMap[playerId].videoEl = video;
            // monitor track ended
            remoteStream.getTracks().forEach(t => {
              t.onended = () => {
                // stream ended - remove UI for that player
                detachPlayerView(playerId);
              }
            });
          } else {
            // unknown player: still show stream in connected panel
            console.warn('Stream for unknown player', remotePeerId);
            // create temp container
            const tempId = 'temp-' + Date.now();
            const tempDiv = document.createElement('div');
            tempDiv.innerText = 'Stream (unknown)';
            document.getElementById('connectedList').appendChild(tempDiv);
            // attach once
            const video = document.createElement('video');
            video.autoplay = true; video.playsInline = true;
            video.srcObject = remoteStream;
            tempDiv.appendChild(video);
          }
        });
        call.on('close', ()=> {
          // call closed -> detach
          const pid = peerIdToPlayer[call.peer];
          if (pid) detachPlayerView(pid);
        });
        call.on('error', e => console.error('call error', e));
      });
    }

    // ensure connected list UI cleared
    renderConnectedList();
  }

  // ---------- Render players (host view + info) ----------
  function renderPlayers(snapshot){
    const container = document.getElementById('playersGrid');
    container.innerHTML = '';
    broadcasterPlayers = [];
    for (const playerId in snapshot){
      const p = snapshot[playerId] || {};
      // create DOM
      const el = document.createElement('div');
      el.className = 'player';
      el.id = 'pl-' + playerId;
      const title = p.title || playerId;
      const ownerUid = p.owner || '—';
      const ownerName = (p.owner && p.ownerName) ? p.ownerName : ownerUid;
      const peerId = p.peerId || '';
      const viewers = p.viewers || {};
      el.innerHTML = `
        <div class="title">${title}</div>
        <div class="meta">Owner: <strong>${ownerName}</strong> • Peer: <span class="peer-id">${peerId || '—'}</span></div>
        <div class="preview"><div class="muted small">No se comparte</div></div>
        <div class="actions">
          <button class="btn btn-sm btn-outline-primary share-btn">${peerId ? 'Compartiendo' : 'Compartir'}</button>
          <button class="btn btn-sm btn-outline-secondary copy-btn">Copiar Peer</button>
          <button class="btn btn-sm btn-outline-danger kick-all-btn">Kick All</button>
        </div>
        <button class="delete-btn" title="Eliminar">×</button>
        <div style="margin-top:8px">
          <div class="small-muted">Conectados:</div>
          <div class="viewer-list small-muted" style="margin-top:6px;max-height:90px;overflow:auto"></div>
        </div>
      `;
      // show viewer list
      const viewerListDiv = el.querySelector('.viewer-list');
      if (Object.keys(viewers).length === 0) {
        viewerListDiv.innerHTML = `<div class="muted small">Nadie conectado</div>`;
      } else {
        viewerListDiv.innerHTML = '';
        for (const uid in viewers) {
          const v = viewers[uid] || {};
          const item = document.createElement('div');
          item.style.display = 'flex';
          item.style.justifyContent = 'space-between';
          item.style.alignItems = 'center';
          item.style.marginBottom = '6px';
          item.innerHTML = `<div>${v.username || uid} ${v.kicked ? '(kicked)' : v.active ? '(activo)' : '(inactivo)'}</div>
                            <div><button class="btn btn-sm btn-outline-danger kick-btn">Kick</button></div>`;
          // kick handler - only owner can kick
          const kickBtn = item.querySelector('.kick-btn');
          kickBtn.addEventListener('click', ()=> {
            if (!currentUser || currentUser.uid !== p.owner) return toast('Solo el owner puede kickear','danger');
            playersRef.child(playerId).child('viewers').child(uid).update({ kicked: true, active: false });
            toast('Kick enviado a ' + (v.username||uid),'info');
          });
          viewerListDiv.appendChild(item);
        }
      }

      // attach actions
      el.querySelector('.share-btn').addEventListener('click', async ()=>{
        // only owner should start sharing -> but we allow starting if currentUser is owner
        if (!currentUser || currentUser.uid !== p.owner) return toast('Solo el owner puede compartir','danger');
        // simulate click on actual share flow: show getDisplayMedia
        startSharingForExistingPlayer(playerId, el);
      });

      el.querySelector('.copy-btn').addEventListener('click', ()=>{
        const pid = el.querySelector('.peer-id').textContent;
        if (!pid || pid === '—') return toast('No hay PeerID','info');
        navigator.clipboard.writeText(pid).then(()=>toast('PeerID copiado','success')).catch(()=>toast('No se pudo copiar','danger'));
      });

      el.querySelector('.delete-btn').addEventListener('click', ()=>{
        if (!currentUser) return toast('No autenticado','info');
        // Only owner can delete
        if (p.owner && currentUser.uid !== p.owner) return toast('Solo el owner puede eliminar','danger');
        playersRef.child(playerId).remove();
        toast('Player eliminado','info');
      });

      el.querySelector('.kick-all-btn').addEventListener('click', ()=>{
        if (!currentUser || currentUser.uid !== p.owner) return toast('Solo el owner puede kickear','danger');
        const viewersNode = playersRef.child(playerId).child('viewers');
        // set kicked = true for all
        for (const uid in viewers) {
          viewersNode.child(uid).update({ kicked: true, active: false });
        }
        toast('Kick all enviado','info');
      });

      // preview: if peerId exists, show small "live" placeholder (but we will update when stream arrives)
      if (peerId) {
        const preview = el.querySelector('.preview');
        preview.innerHTML = `<div class="muted small">Player está compartiendo — espera conexión</div>`;
      }

      container.appendChild(el);
    }
  }

  // ---------- Add player (owner creates) ----------
  document.getElementById('addPlayer').addEventListener('click', ()=>{
    if (!currentUser) return toast('Inicia sesión para crear Player','info');
    const idx = getNextPlayerNumber();
    const pid = `player-${Date.now()}-${Math.floor(Math.random()*999)}`;
    const ownerName = currentProfile.username;
    playersRef.child(pid).set({
      owner: currentUser.uid,
      ownerName: ownerName,
      title: `Player ${idx}`,
      peerId: '',
      viewers: {},
      locked: false,
      createdAt: Date.now()
    });
    toast('Player creado','success');
  });

  function getNextPlayerNumber(){
    // simple count
    return Object.keys(playersSnapshot || {}).length + 1;
  }

  // ---------- Start sharing for an existing player (owner flow) ----------
  async function startSharingForExistingPlayer(playerId, elDom){
    // This is used when owner clicks "Compartir" on existing player element.
    // The page running this code must be the owner (we check).
    const pSnap = playersSnapshot[playerId] || {};
    if (!currentUser || pSnap.owner !== currentUser.uid) return toast('No eres el owner','danger');

    try {
      const quality = document.getElementById('quality').value.split('@')[0].split('x');
      const fps = parseInt(document.getElementById('quality').value.split('@')[1] || '15');
      const width = parseInt(quality[0]) || 1280;
      const height = parseInt(quality[1]) || 720;
      const stream = await navigator.mediaDevices.getDisplayMedia({ video:{ width, height, frameRate: fps }, audio:false });
      // create Peer for this player
      const peer = new Peer(peerOptions());
      // store peer on DOM for cleanup
      elDom._playerPeer = peer;
      elDom._stream = stream;
      peer.on('open', id=>{
        playersRef.child(playerId).update({ peerId: id, title: pSnap.title || 'Player' });
        toast('Peer listo: ' + id, 'success');
      });
      peer.on('connection', conn=>{
        conn.on('open', ()=>{
          conn.on('data', data=>{
            // expect { type:'request', viewerUid, username }
            if (data && data.type === 'request') {
              const viewerUid = data.viewerUid;
              const username = data.username || 'guest';
              // register viewer in DB (keeps record even if disconnect)
              const viewerRef = playersRef.child(playerId).child('viewers').child(viewerUid);
              viewerRef.update({ username, connectedAt: Date.now(), active: true, kicked: false });
              // send call to viewer
              const call = peer.call(conn.peer, stream);
              call.on('error', e=>console.error('Call err', e));
            } else if (data && data.type === 'control') {
              // forward event to page (useful if embedding Roblox web)
              window.dispatchEvent(new CustomEvent('remote-control', { detail: data }));
            }
          });
          conn.on('close', ()=>{
            // When dataConn closes, find viewer UID - can't rely on conn meta, so rely on DB presence; we will mark as inactive
            // we might not know UID here; better rely on DB presence and viewer heartbeats (viewer will set active:false)
          });
        });
      });
      peer.on('call', call => call.answer(stream));
      // when stream ends
      stream.getTracks().forEach(t => t.onended = ()=> {
        // clear peerId and mark viewers inactive
        playersRef.child(playerId).update({ peerId: '' });
        // mark viewers active=false (but keep record)
        playersRef.child(playerId).child('viewers').once('value').then(snap=>{
          const vs = snap.val() || {};
          for (const uid in vs) playersRef.child(playerId).child('viewers').child(uid).update({ active: false });
        });
        if (elDom._playerPeer) try { elDom._playerPeer.destroy(); } catch(e){}
      });

      // attach preview locally
      const preview = elDom.querySelector('.preview');
      preview.innerHTML = '';
      const v = document.createElement('video');
      v.autoplay = true; v.playsInline = true; v.muted = true;
      v.srcObject = stream;
      preview.appendChild(v);

    } catch(e){
      toast('Error compartiendo: ' + (e.message || e), 'danger');
    }
  }

  // ---------- Viewer: connect to player(s) (multiple) ----------
  document.getElementById('refreshBtn').addEventListener('click', ()=> {
    // just refresh players snapshot is automatic via on('value'), but we can show toast
    toast('Lista actualizada', 'info');
  });

  // function to connect to a player by id (viewer)
  async function connectToPlayerAsViewer(playerId){
    if (!currentUser) return toast('Inicia sesión para conectar','info');
    const p = playersSnapshot[playerId] || {};
    if (!p.peerId) return toast('Ese player no está compartiendo','info');
    const peerId = p.peerId;
    // open data connection
    const conn = viewerPeer.connect(peerId, { reliable:true });
    conn.on('open', ()=>{
      // send request with uid and username
      conn.send({ type:'request', viewerUid: currentUser.uid, username: currentProfile.username });
      // write to DB viewers map to persist connection even if disconnects later
      playersRef.child(playerId).child('viewers').child(currentUser.uid).update({ username: currentProfile.username, connectedAt: Date.now(), active:true, kicked:false });
      // store mapping
      const container = createConnectedUIEntry(playerId, p.title || playerId, peerId);
      connectedMap[playerId] = { dataConn: conn, container, peerId };
      toast('Conectado: ' + (p.title || playerId), 'success');
      // listen for kicked flag
      playersRef.child(playerId).child('viewers').child(currentUser.uid).on('value', snap=>{
        const val = snap.val();
        if (!val) return;
        if (val.kicked) {
          toast('Has sido kickeado del player ' + (p.title || playerId),'danger');
          // close dataConn and remove UI
          try { if (connectedMap[playerId] && connectedMap[playerId].dataConn) connectedMap[playerId].dataConn.close(); } catch(e){}
          detachPlayerView(playerId);
          // mark active false
          playersRef.child(playerId).child('viewers').child(currentUser.uid).update({ active:false });
        }
      });
    });
    conn.on('error', e=> { console.error('dataConn error', e); toast('Error de conexión','danger') });
    // the actual media call will be answered and viewerPeer.on('call') will handle stream attach
  }

  // create UI entry on side for connected players
  function createConnectedUIEntry(playerId, title, peerId){
    const list = document.getElementById('connectedList');
    // clear placeholder
    if (list.children.length === 1 && list.children[0].classList.contains('muted')) list.innerHTML = '';
    const card = document.createElement('div');
    card.className = 'viewer-chip';
    const left = document.createElement('div'); left.innerHTML = `<strong>${title}</strong><div class="muted small">${playerId}</div>`;
    const right = document.createElement('div');
    right.innerHTML = `<button class="btn btn-sm btn-outline-danger disconnect-btn">Desconectar</button>`;
    card.appendChild(left); card.appendChild(right);
    list.appendChild(card);
    // a container for video below title (for inline preview)
    const preview = document.createElement('div'); preview.style.marginTop = '6px'; preview.style.minHeight = '100px';
    card.appendChild(preview);
    // disconnect handler
    right.querySelector('.disconnect-btn').addEventListener('click', ()=>{
      // close dataConn and call
      if (connectedMap[playerId] && connectedMap[playerId].dataConn) {
        try { connectedMap[playerId].dataConn.close(); } catch(e){}
      }
      // mark active false in DB
      playersRef.child(playerId).child('viewers').child(currentUser.uid).update({ active:false });
      // remove UI
      card.remove();
      delete connectedMap[playerId];
      if (Object.keys(connectedMap).length === 0) {
        document.getElementById('connectedList').innerHTML = '<div class="muted small">No estás conectado a ningún Player.</div>';
      }
    });
    return preview;
  }

  // detach player view when stream ends or call closed
  function detachPlayerView(playerId){
    if (connectedMap[playerId]) {
      const ent = connectedMap[playerId];
      if (ent.videoEl && ent.videoEl.srcObject) {
        try {
          ent.videoEl.srcObject.getTracks().forEach(t => t.stop());
        } catch(e){}
      }
      // remove UI entry
      const list = document.getElementById('connectedList');
      // find the corresponding card by checking child text
      for (const child of Array.from(list.children)) {
        if (child.innerText && child.innerText.includes(playerId)) {
          child.remove();
        }
      }
      delete connectedMap[playerId];
      if (Object.keys(connectedMap).length === 0) document.getElementById('connectedList').innerHTML = '<div class="muted small">No estás conectado a ningún Player.</div>';
    }
    // also mark viewer DB entry active=false
    if (currentUser) playersRef.child(playerId).child('viewers').child(currentUser.uid).update({ active:false });
  }

  // ---------- Watch for players where peerId becomes empty (host stopped sharing) ----------
  playersRef.on('child_changed', snap=>{
    const pid = snap.key;
    const data = snap.val() || {};
    // if peerId cleared, notify all viewers that were connected and detach local UI if viewer
    if (!data.peerId) {
      // find all connectedMap entries matching this pid and detach
      if (connectedMap[pid]) detachPlayerView(pid);
      // mark viewers inactive (DB)
      playersRef.child(pid).child('viewers').once('value').then(snap2=>{
        const vs = snap2.val() || {};
        for (const uid in vs) playersRef.child(pid).child('viewers').child(uid).update({ active:false });
      });
      // update UI preview to "no share"
      const dom = document.getElementById('pl-' + pid);
      if (dom) {
        const preview = dom.querySelector('.preview');
        preview.innerHTML = `<div class="muted small">No se comparte</div>`;
        const peerSpan = dom.querySelector('.peer-id');
        if (peerSpan) peerSpan.textContent = '—';
      }
    } else {
      // peerId present -> update mapping
      peerIdToPlayer[data.peerId] = pid;
      const dom = document.getElementById('pl-' + pid);
      if (dom) {
        const peerSpan = dom.querySelector('.peer-id');
        if (peerSpan) peerSpan.textContent = data.peerId;
      }
    }
  });

  // ---------- Utility: connect UI (click on player preview to connect as viewer) ----------
  document.addEventListener('click', e=>{
    const el = e.target;
    // If clicked inside a player card and not owner actions, try to connect as viewer
    const card = el.closest('.player');
    if (!card) return;
    const playerDomId = card.id; // 'pl-' + playerId
    const playerId = playerDomId.replace(/^pl-/, '');
    // if clicked on buttons, ignore
    if (el.closest('button')) return;
    // if current user is owner of that player, do nothing
    const p = playersSnapshot[playerId] || {};
    if (p.owner && currentUser && p.owner === currentUser.uid) return;
    // else connect to player as viewer (multiple allowed)
    connectToPlayerAsViewer(playerId);
  });

  // ---------- Initial small UI setup ----------
  document.getElementById('peerLabel').textContent = PEERJS_USE_CLOUD ? 'PeerJS Cloud' : 'Custom';
  // set initial connectedList placeholder
  document.getElementById('connectedList').innerHTML = '<div class="muted small">No estás conectado a ningún Player.</div>';
  // show firebase status if possible
  db.ref('.info/connected').on('value', snap=> {
    const v = snap.val();
    document.getElementById('fbLabel').textContent = v ? 'Conectado' : 'Desconectado';
  });

  </script>
</body>
</html>
