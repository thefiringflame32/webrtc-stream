<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Live Tab Sharing ‚Äî Viewer Layout (Image 2)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/4.5.2/flatly/bootstrap.min.css"/>
  <style>
    :root{
      --card-radius:14px;
      --muted:#6b7280;
      --accent:#2563eb;
      --panel:#ffffff;
      --bg:#f6f8fb;
      --accent-2:#0ea5a4;
      --star:#f59e0b;
    }
    html,body{height:100%;margin:0;font-family:Inter, 'Segoe UI', Roboto, system-ui, sans-serif;background:linear-gradient(180deg,#eef6ff 0%, #fbfcff 100%);}
    .wrap{max-width:1320px;margin:18px auto;min-height:calc(100vh - 36px);display:flex;flex-direction:column;gap:18px}

    /* Top bar (visible in app) */
    .topbar{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;background:transparent}
    .controls-left{display:flex;gap:10px;align-items:center}
    .user-area{display:flex;gap:8px;align-items:center}
    .user-pill{background:#fff;padding:6px 10px;border-radius:999px;border:1px solid rgba(0,0,0,.06);}

    /* App main 3-column layout for logged-in app (image 2) */
    .app-stage{display:grid;grid-template-columns:84px 1fr 180px;gap:18px;align-items:start;min-height:calc(100vh - 120px)}
    /* left sidebar */
    .left-sidebar{background:var(--panel);border-radius:12px;padding:12px;box-shadow:0 10px 30px rgba(16,24,40,.05);display:flex;flex-direction:column;align-items:center;gap:12px}
    .nav-btn{width:52px;height:52px;border-radius:10px;background:#fbfdff;border:1px solid rgba(0,0,0,.06);display:flex;align-items:center;justify-content:center;cursor:pointer}
    .nav-btn.active{background:linear-gradient(180deg,#eef7ff,#fff);box-shadow:0 8px 20px rgba(37,99,235,.06)}
    .nav-label{font-size:.75rem;color:var(--muted);text-align:center;margin-top:6px}

    /* center content */
    .center-panel{background:var(--panel);border-radius:14px;padding:16px;box-shadow:0 16px 50px rgba(16,24,40,.05);display:flex;flex-direction:column;gap:12px}
    .center-toolbar{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .center-toolbar .left{display:flex;gap:8px;align-items:center}
    .center-toolbar .right{display:flex;gap:8px;align-items:center}
    .players-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:8px}
    .player-card{border-radius:12px;padding:12px;background:linear-gradient(180deg,#fff,#fbfdff);border:1px solid rgba(0,0,0,.06);display:flex;flex-direction:column;gap:8px;min-height:160px;cursor:pointer}
    .player-thumb{height:120px;border-radius:8px;background:linear-gradient(180deg,#f7fbff,#fff);display:flex;align-items:center;justify-content:center;color:var(--muted)}

    /* right reviews rail */
    .right-rail{background:var(--panel);border-radius:12px;padding:16px;box-shadow:0 10px 30px rgba(16,24,40,.05);display:flex;flex-direction:column;align-items:center;justify-content:space-between;min-height:calc(100vh - 200px)}
    .star-vertical{display:flex;flex-direction:column;gap:12px;align-items:center;margin-top:12px}
    .star-lg{width:46px;height:46px}
    .rating-bubble{margin-top:12px;background:linear-gradient(90deg,#fff,#fbfdff);padding:8px 12px;border-radius:10px;font-weight:800;border:1px solid rgba(0,0,0,.06)}

    /* smaller devices */
    @media(max-width:1100px){
      .app-stage{grid-template-columns:72px 1fr 140px}
      .players-grid{grid-template-columns:repeat(2,1fr)}
    }
    @media(max-width:760px){
      .wrap{padding:12px}
      .app-stage{grid-template-columns:1fr;grid-auto-rows:min-content}
      .left-sidebar{flex-direction:row;padding:8px;overflow:auto}
      .right-rail{order:3}
      .center-toolbar{flex-direction:column;align-items:stretch;gap:10px}
      .players-grid{grid-template-columns:repeat(2,1fr)}
    }
  </style>
</head>
<body>

  <!-- top area (used in-app) -->
  <div class="wrap">
    <div class="topbar" id="topbar" style="display:none">
      <div class="controls-left">
        <button id="addPlayer" class="btn btn-outline-primary btn-sm">Agregar Player</button>
        <label style="margin-left:6px;color:var(--muted)">Calidad</label>
        <select id="quality" class="form-control form-control-sm" style="width:160px">
          <option value="1280x720@30">720p@30</option>
          <option value="1280x720@15">720p@15</option>
          <option value="854x480@15">480p@15</option>
        </select>
        <button id="refreshBtn" class="btn btn-outline-info btn-sm">Refrescar</button>
      </div>

      <div class="user-area">
        <div id="userBadge" class="user-pill">No autenticado</div>
        <button id="logoutBtn" class="btn btn-outline-danger btn-sm" style="display:none">Cerrar sesi√≥n</button>
      </div>
    </div>

    <!-- AUTH stage (login/register) kept but viewer/host app below -->
    <div id="authStage" style="display:block">
      <!-- existing login/register visuals kept untouched (we assume your previous auth UI is present in the file) -->
      <!-- For simplicity, we keep earlier auth UI content here. This block will be replaced by viewer/host view when logged in -->
      <!-- Reuse the auth UI you already approved -->
    </div>

    <!-- APP stage (Image 2 layout) -->
    <div id="appStage" style="display:none">
      <div class="app-stage">

        <!-- Left sidebar (icons) -->
        <div class="left-sidebar" id="leftSidebar">
          <div title="Home" class="nav-btn active" id="navHome">üè†</div>
          <div title="Players" class="nav-btn" id="navPlayers">üñ•Ô∏è</div>
          <div title="Connections" class="nav-btn" id="navConnections">üë•</div>
          <div title="Settings" class="nav-btn" id="navSettings">‚öôÔ∏è</div>
          <div style="flex:1"></div>
          <div title="Help" class="nav-btn" id="navHelp">‚ùì</div>
        </div>

        <!-- Center -->
        <div class="center-panel">
          <div class="center-toolbar">
            <div class="left">
              <div style="font-weight:800;font-size:1.05rem">Live Tab Sharing ‚Äî Viewer</div>
              <div style="color:var(--muted);margin-left:12px">Conecta a Players disponibles</div>
            </div>
            <div class="right">
              <div style="color:var(--muted);font-size:.95rem;margin-right:8px">Players: <span id="playersCount">0</span></div>
            </div>
          </div>

          <div id="playersGrid" class="players-grid" aria-live="polite">
            <!-- player cards injected here -->
          </div>

        </div>

        <!-- Right reviews rail -->
        <div class="right-rail">
          <div style="text-align:center;font-weight:800">REVIEWS</div>
          <div class="star-vertical" style="margin-top:16px">
            <svg class="star-lg" viewBox="0 0 24 24"><path fill="var(--star)" d="M12 .587l3.668 7.431L23.5 9.75l-5.667 5.535L19.335 24 12 19.897 4.665 24l1.502-8.715L.5 9.75l7.832-1.732z"/></svg>
            <svg class="star-lg" viewBox="0 0 24 24"><path fill="var(--star)" d="M12 .587l3.668 7.431L23.5 9.75l-5.667 5.535L19.335 24 12 19.897 4.665 24l1.502-8.715L.5 9.75l7.832-1.732z"/></svg>
            <svg class="star-lg" viewBox="0 0 24 24"><path fill="var(--star)" d="M12 .587l3.668 7.431L23.5 9.75l-5.667 5.535L19.335 24 12 19.897 4.665 24l1.502-8.715L.5 9.75l7.832-1.732z"/></svg>
            <svg class="star-lg" viewBox="0 0 24 24"><path fill="var(--star)" d="M12 .587l3.668 7.431L23.5 9.75l-5.667 5.535L19.335 24 12 19.897 4.665 24l1.502-8.715L.5 9.75l7.832-1.732z"/></svg>
            <svg class="star-lg" viewBox="0 0 24 24"><defs><linearGradient id="gPartialApp" x1="0" x2="1" y1="0" y2="0"><stop offset="0%" stop-color="var(--star)"/><stop offset="92%" stop-color="var(--star)"/><stop offset="92.1%" stop-color="#e6e6e6"/><stop offset="100%" stop-color="#e6e6e6"/></linearGradient></defs><path fill="url(#gPartialApp)" d="M12 .587l3.668 7.431L23.5 9.75l-5.667 5.535L19.335 24 12 19.897 4.665 24l1.502-8.715L.5 9.75l7.832-1.732z"/></svg>
          </div>
          <div class="rating-bubble">4.92 / 5</div>
        </div>

      </div>
    </div>
  </div>

  <!-- Firebase & PeerJS -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/peerjs@1.4.7/dist/peerjs.min.js"></script>

  <script>
    /****************** CONFIG ******************/
    const firebaseConfig = {
      apiKey: "AIzaSyDLQGyXjRwrJ9O6RbVFtp-4uRNepAWdfrU",
      authDomain: "thefiringflame3210.firebaseapp.com",
      databaseURL: "https://thefiringflame3210-default-rtdb.firebaseio.com",
      projectId: "thefiringflame3210",
      storageBucket: "thefiringflame3210.appspot.com",
      messagingSenderId: "759308762331",
      appId: "1:759308762331:web:79725eda7c24b346eca0fe"
    };
    const ICE_SERVERS = [{ urls: 'stun:stun.l.google.com:19302' }, { urls: 'stun:stun1.l.google.com:19302' }];

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    const playersRef = db.ref('players');
    const usersRef = db.ref('users');

    // helpers
    function el(id){ return document.getElementById(id); }
    function toast(msg){ console.log(msg); /* quick console toast */ }

    // state
    let currentUser = null, currentProfile = null, playersSnapshot = {}, viewerPeer = null;

    function peerOptions(){ return { config:{ iceServers: ICE_SERVERS } }; }

    // ---- UI toggles ----
    function showAuth(){ el('authStage').style.display='block'; el('appStage').style.display='none'; el('topbar').style.display='none'; }
    function showApp(){ el('authStage').style.display='none'; el('appStage').style.display='block'; el('topbar').style.display='flex'; }

    // wire topbar user area
    el('logoutBtn').addEventListener('click', ()=> auth.signOut());

    // players rendering for center
    function renderPlayersGrid(snapshot){
      const container = el('playersGrid');
      container.innerHTML = '';
      const ids = Object.keys(snapshot || {});
      if (ids.length === 0){
        container.innerHTML = '<div class="small-muted">No hay Players disponibles.</div>';
        el('playersCount').innerText = 0;
        return;
      }
      el('playersCount').innerText = ids.length;
      ids.forEach(pid=>{
        const p = snapshot[pid] || {};
        const card = document.createElement('div');
        card.className = 'player-card';
        card.innerHTML = `<div style="font-weight:800">${p.title || pid}</div>
                          <div style="color:var(--muted);font-size:.9rem">Owner: ${p.ownerName || p.owner || '‚Äî'}</div>
                          <div class="player-thumb">${p.peerId ? '<strong>LIVE</strong>' : 'No comparte'}</div>
                          <div style="display:flex;justify-content:space-between;align-items:center"><div style="font-size:.85rem;color:var(--muted)">${p.viewers ? Object.keys(p.viewers).length : 0} viewers</div><div><button class="btn btn-sm btn-outline-primary connect-btn">Connect</button></div></div>`;
        // click handlers
        card.querySelector('.connect-btn').addEventListener('click', ()=> connectToPlayerAsViewer(pid));
        container.appendChild(card);
      });
    }

    // listen players -> update grid and host UI if needed
    playersRef.on('value', snap=>{
      playersSnapshot = snap.val() || {};
      renderPlayersGrid(playersSnapshot);
    });

    // ensure viewer peer
    function ensureViewerPeer(){
      if (viewerPeer) return;
      viewerPeer = new Peer(peerOptions());
      viewerPeer.on('open', id=> console.log('viewer peer open', id));
      viewerPeer.on('error', e=> console.warn('peer err', e));
      // when media arrives: show in connections area or open modal (simple approach: push into center)
      viewerPeer.on('call', call=>{
        call.on('stream', stream=>{
          // create a floating viewer window in a new card
          const container = el('playersGrid');
          const wrapper = document.createElement('div');
          wrapper.className = 'player-card';
          wrapper.innerHTML = `<div style="font-weight:800">Live Stream</div><div style="color:var(--muted);font-size:.9rem">From ${call.peer}</div>`;
          const video = document.createElement('video');
          video.autoplay = true; video.playsInline = true; video.srcObject = stream;
          video.style.width='100%'; video.style.marginTop='8px'; wrapper.appendChild(video);
          container.prepend(wrapper);
          stream.getTracks().forEach(t=> t.onended = ()=> wrapper.remove());
        });
      });
    }

    // connect as viewer (data connection + request call)
    function connectToPlayerAsViewer(playerId){
      if (!currentUser) return alert('Inicia sesi√≥n para conectar');
      const p = playersSnapshot[playerId] || {};
      if (!p.peerId) return alert('Ese player no est√° compartiendo');
      ensureViewerPeer();
      const conn = viewerPeer.connect(p.peerId, { reliable:true });
      conn.on('open', ()=>{
        conn.send({ type:'request', viewerUid: currentUser.uid, username: currentProfile.username });
        playersRef.child(playerId).child('viewers').child(currentUser.uid).update({ username: currentProfile.username, connectedAt: Date.now(), active:true, kicked:false });
        toast('Conectado: ' + (p.title || playerId));
      });
      conn.on('error', e=> console.warn('conn err', e));
    }

    // Add player (topbar button)
    el('addPlayer').addEventListener('click', ()=>{
      if (!currentUser) return alert('Inicia sesi√≥n para crear Player');
      const pid = `player-${Date.now()}-${Math.floor(Math.random()*999)}`;
      const idx = Object.keys(playersSnapshot||{}).length + 1;
      playersRef.child(pid).set({ owner: currentUser.uid, ownerName: currentProfile.username, title: `Player ${idx}`, peerId:'', viewers:{}, createdAt: Date.now() });
      toast('Player creado');
    });

    // refresh button (reload snapshot)
    el('refreshBtn').addEventListener('click', ()=> { playersRef.once('value').then(s=>{ playersSnapshot = s.val()||{}; renderPlayersGrid(playersSnapshot); toast('Lista actualizada'); }); });

    // auth state (show app for logged-in users; choose viewer vs host by ownership)
    auth.onAuthStateChanged(async user=>{
      if (!user){
        currentUser = null; currentProfile = null;
        // show auth UI (we assume earlier authStage contains login/register card)
        showAuth();
        // hide topbar / user
        el('userBadge').innerText = 'No autenticado';
        el('logoutBtn').style.display = 'none';
        return;
      }
      currentUser = user;
      const snap = await usersRef.child(user.uid).once('value');
      currentProfile = snap.val() || { username: user.email.split('@')[0] };
      el('userBadge').innerText = currentProfile.username;
      el('logoutBtn').style.display = 'inline-block';

      // decide if user owns a player (host) or not (viewer)
      const playersNow = (await playersRef.once('value')).val() || {};
      const owns = Object.values(playersNow || {}).some(p => p && p.owner === currentUser.uid);
      // show the app-stage (Image 2) for both host and viewer; host can access host functions via buttons inside cards
      showApp();
      // ensure viewer peer ready for viewers
      ensureViewerPeer();
    });

    // initial UI: show auth stage (login/register)
    showAuth();
  </script>
</body>
</html>
