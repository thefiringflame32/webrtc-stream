<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Live Tab Sharing — Mejorado</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/4.5.2/flatly/bootstrap.min.css"/>
  <style>
    :root{
      --card-radius:14px;
      --muted:#6c757d;
    }
    body{background:linear-gradient(180deg,#eef6ff 0%, #f5f7fa 100%);font-family:Inter,Segoe UI,Roboto, system-ui, sans-serif;margin:0;padding:20px}
    .app-shell{max-width:1150px;margin:0 auto}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:48px;height:48px;border-radius:10px;background:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;color:#2b6cb0;box-shadow:0 6px 18px rgba(85,85,85,.06)}
    .hero {background:#fff;border-radius:var(--card-radius);padding:18px;box-shadow:0 10px 30px rgba(9,30,66,.04);display:flex;gap:20px;align-items:center}
    .left{flex:1}
    .right{width:320px}
    .muted{color:var(--muted)}
    #gridContainer{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px;margin-top:14px}
    .player-cell{background:#fff;border-radius:12px;padding:8px;border:1px solid rgba(27,31,35,.06);position:relative;overflow:hidden;min-height:150px;display:flex;flex-direction:column}
    .player-title{font-size:.95rem;font-weight:600;color:#2c3e50}
    .player-meta{font-size:.8rem;color:var(--muted);margin-top:4px}
    .cell-content{flex:1;display:flex;align-items:center;justify-content:center;margin-top:8px;border-radius:8px;background:linear-gradient(180deg,#f8fbff,#ffffff);overflow:hidden}
    .cell-content video{width:100%;height:100%;object-fit:cover;border-radius:6px}
    .controls-row{display:flex;gap:8px;align-items:center;margin-top:10px}
    .btn-sm-wide{padding-left:10px;padding-right:10px}
    .badge-status{position:absolute;top:10px;left:10px;font-size:.75rem}
    .delete-player{position:absolute;top:10px;right:10px;border:none;background:transparent;color:#d9534f;font-weight:700}
    .toast-wrap{position:fixed;right:20px;bottom:20px;z-index:2000}
    footer{margin-top:22px;color:var(--muted);font-size:.85rem;text-align:center}
    @media(max-width:600px){ .right{display:none} .hero{flex-direction:column} }
  </style>
</head>
<body>
  <div class="app-shell">
    <header>
      <div class="brand">
        <div class="logo">LTS</div>
        <div>
          <div style="font-weight:700;font-size:1.05rem">Live Tab Sharing</div>
          <div class="muted">Compartir pantallas rápido — control opcional</div>
        </div>
      </div>
      <div id="userActions" style="display:flex;gap:8px;align-items:center">
        <div id="userBadge" class="muted small">No autenticado</div>
      </div>
    </header>

    <div class="hero">
      <div class="left">
        <div id="authContainer" class="p-2">
          <div class="card" style="border-radius:12px">
            <div class="card-body">
              <h5 class="card-title">Inicia Sesión / Regístrate</h5>
              <div class="row">
                <div class="col-sm-6">
                  <form id="login-form">
                    <input type="email" id="loginEmail" class="form-control mb-2" placeholder="Correo" required>
                    <input type="password" id="loginPassword" class="form-control mb-2" placeholder="Contraseña" required>
                    <button class="btn btn-primary btn-block">Iniciar Sesión</button>
                  </form>
                </div>
                <div class="col-sm-6">
                  <form id="signup-form">
                    <input type="email" id="signupEmail" class="form-control mb-2" placeholder="Correo" required>
                    <input type="password" id="signupPassword" class="form-control mb-2" placeholder="Contraseña" required>
                    <button class="btn btn-success btn-block">Registrarse</button>
                  </form>
                  <hr/>
                  <form id="email-link-form">
                    <input type="email" id="emailLinkEmail" class="form-control mb-2" placeholder="Correo para enlace" required>
                    <button class="btn btn-warning btn-block">Enviar vínculo</button>
                  </form>
                </div>
              </div>
              <div id="authMessage" class="mt-2 text-center small muted"></div>
            </div>
          </div>
        </div>

        <div id="mainContainer" style="display:none">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div>
              <h5 id="welcomeText" style="margin:0">Bienvenido</h5>
              <div class="muted small">Tu rol se detecta automáticamente</div>
            </div>
            <div>
              <div class="btn-group">
                <button id="btnAddPlayer" class="btn btn-outline-primary btn-sm">Agregar Player</button>
                <div class="btn btn-sm btn-secondary small">Players: <span id="playerCount">0</span></div>
              </div>
            </div>
          </div>

          <div class="card p-3" style="border-radius:12px">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="controls-row">
                <label class="muted small mr-2">Calidad</label>
                <select id="qualitySelect" class="form-control form-control-sm" style="width:170px">
                  <option value="1280x720@30">720p @ 30fps — balance</option>
                  <option value="1280x720@15">720p @ 15fps — latencia</option>
                  <option value="854x480@15">480p @ 15fps — rápido</option>
                </select>
                <button id="btnRefreshPlayers" class="btn btn-outline-info btn-sm btn-sm-wide">Actualizar</button>
              </div>
              <div class="muted small">STUN/TURN configurable</div>
            </div>

            <div id="gridContainer" aria-live="polite"></div>
          </div>
        </div>
      </div>

      <div class="right">
        <div class="card" style="border-radius:12px">
          <div class="card-body">
            <h6>Estado</h6>
            <ul class="list-unstyled small muted">
              <li>PeerJS signaling: <span id="peerServerLabel">Pendiente</span></li>
              <li>Firebase: <span id="firebaseStatus">Pendiente</span></li>
              <li>Control remoto: <span id="controlStatus">Desactivado</span></li>
            </ul>
            <hr/>
            <h6>Instrucciones rápidas</h6>
            <ol class="small">
              <li>Autentícate (email/contraseña o enlace).</li>
              <li>Como broadcaster: crea un Player y pulsa "Agregar Tab".</li>
              <li>Como viewer: conecta a un Player desde la lista (en otra sesión).</li>
            </ol>
          </div>
        </div>
      </div>
    </div>

    <div class="toast-wrap" id="toastWrap"></div>
    <footer>Live Tab Sharing — mejorado &middot; Si quieres, despliego PeerJS server en Railway y configuro TURN.</footer>
  </div>

  <!-- Dependencias (compat para Firebase) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/peerjs@1.4.7/dist/peerjs.min.js"></script>

  <script>
  /**************************************************************************
   *  CONFIGURACIÓN (cambia aquí según necesites)
   **************************************************************************/
  // 1) Firebase: reemplaza con tu firebaseConfig del nuevo proyecto
  const firebaseConfig = {
    apiKey: "REEMPLAZA_APIKEY",
    authDomain: "REEMPLAZA_PROJECT.firebaseapp.com",
    projectId: "REEMPLAZA_PROJECT",
    databaseURL: "https://REEMPLAZA_PROJECT-default-rtdb.europe-west1.firebasedatabase.app",
    storageBucket: "REEMPLAZA_PROJECT.appspot.com",
    messagingSenderId: "REEMPLAZA",
    appId: "REEMPLAZA"
  };

  // 2) PeerJS / Signaling: elige una opción
  //    A) Usar PeerServer Cloud (fácil): deja PEERJS_USE_CLOUD = true (no config adicional)
  //    B) O desplegar tu propio peerjs-server y poner host/port/secure/path abajo
  const PEERJS_USE_CLOUD = true;
  const PEERJS_CUSTOM = {
    host: "your-peerjs-host.example.com",
    port: 443,
    path: "/peerjs",
    secure: true
  };

  // 3) ICE / STUN / TURN: puedes añadir tu TURN si tienes (recomendado para NATs)
  const ICE_SERVERS = [
    { urls: 'stun:stun.l.google.com:19302' },
    { urls: 'stun:stun1.l.google.com:19302' }
    // Si tienes coturn o Xirsys añade:
    // { urls: 'turn:mi-turn.example.com:3478', username: 'user', credential:'pass' }
  ];

  /**************************************************************************
   *  FIN CONFIG
   **************************************************************************/

  // --- init firebase compat
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();
  const playersRef = db.ref('players');

  // Peer options factory
  function peerOptions(){
    // if cloud, return {} so PeerJS connects to peerjs cloud automatically.
    if (PEERJS_USE_CLOUD) {
      return { config: { iceServers: ICE_SERVERS } };
    }
    // else use custom host (your deployed peerjs-server)
    return {
      host: PEERJS_CUSTOM.host,
      port: PEERJS_CUSTOM.port,
      path: PEERJS_CUSTOM.path || '/peerjs',
      secure: !!PEERJS_CUSTOM.secure,
      config: { iceServers: ICE_SERVERS }
    };
  }

  // UI helpers
  const authMessage = document.getElementById('authMessage');
  function toast(msg, type='info'){ // types: info, success, danger
    const wrap = document.getElementById('toastWrap');
    const id = 't'+Date.now();
    const div = document.createElement('div');
    div.className = `alert alert-${type} alert-dismissible fade show`;
    div.innerHTML = msg + `<button type="button" class="close" data-dismiss="alert">&times;</button>`;
    wrap.appendChild(div);
    setTimeout(()=>{ try{ $(div).alert('close') }catch(e){ div.remove() } }, 5000);
  }
  function showAuthMessage(msg,isErr=false){ authMessage.textContent = msg; authMessage.style.color = isErr ? '#d9534f' : '#28a745' }

  // attach forms
  document.getElementById('login-form').addEventListener('submit', e=>{
    e.preventDefault();
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    auth.signInWithEmailAndPassword(email,password).then(cred=>{
      showAuthMessage(`Bienvenido ${cred.user.email}`);
    }).catch(err=>{ showAuthMessage(err.message,true); toast(err.message,'danger') });
  });
  document.getElementById('signup-form').addEventListener('submit', e=>{
    e.preventDefault();
    const email = document.getElementById('signupEmail').value;
    const password = document.getElementById('signupPassword').value;
    auth.createUserWithEmailAndPassword(email,password).then(cred=>{
      showAuthMessage(`Registro exitoso: ${cred.user.email}`);
    }).catch(err=>{ showAuthMessage(err.message,true); toast(err.message,'danger') });
  });
  const actionCodeSettings = { url: window.location.href, handleCodeInApp: true };
  document.getElementById('email-link-form').addEventListener('submit', e=>{
    e.preventDefault();
    const email = document.getElementById('emailLinkEmail').value;
    auth.sendSignInLinkToEmail(email, actionCodeSettings).then(()=>{
      window.localStorage.setItem('emailForSignIn', email);
      toast(`Vínculo enviado a ${email}`, 'success');
    }).catch(err=>{ toast(err.message,'danger') });
  });

  // safety: avoid double-attach control listeners
  let viewerControlListenersAdded = false;

  // state
  let isBroadcaster = false;
  let broadcasterPlayers = [];
  function getNextPlayerNumber(){ let n=1; while(broadcasterPlayers.includes(n)) n++; return n; }

  // On auth state
  auth.onAuthStateChanged(user=>{
    if (!user) return;
    document.getElementById('authContainer').style.display = 'none';
    document.getElementById('mainContainer').style.display = 'block';
    document.getElementById('welcomeText').textContent = `Bienvenido ${user.email}`;
    document.getElementById('userBadge').textContent = user.email;
    // Decide role; update this logic as you wish:
    isBroadcaster = (user.email === "thefiringflame32@gmail.com"); // ajusta si quieres otra regla
    document.getElementById('peerServerLabel').textContent = PEERJS_USE_CLOUD ? 'PeerJS Cloud' : `${PEERJS_CUSTOM.host}:${PEERJS_CUSTOM.port}${PEERJS_CUSTOM.path||''}`;
    document.getElementById('firebaseStatus').textContent = 'Conectado';
    if (isBroadcaster) {
      document.getElementById('btnAddPlayer').style.display='inline-block';
      initBroadcaster();
    } else {
      document.getElementById('btnAddPlayer').style.display='none';
      initViewer();
    }
  });

  // ---- Broadcaster code (mejorado)
  document.getElementById('btnAddPlayer').addEventListener('click', addPlayerCell);
  document.getElementById('btnRefreshPlayers').addEventListener('click', ()=>{ loadPlayersList(); toast('Refrescado', 'info') });

  playersRef.on('value', snap=>{
    const players = snap.val() || {};
    const count = Object.keys(players).length;
    document.getElementById('playerCount').textContent = count;
  });

  function initBroadcaster(){
    // listen children added/removed
    playersRef.on('child_added', snap=>{
      const key = snap.key;
      const data = snap.val();
      if (!document.getElementById(key)){
        const playerNumber = parseInt((data.title||'').replace(/\D/g,'')) || getNextPlayerNumber();
        broadcasterPlayers.push(playerNumber);
        renderPlayerFromData(key, data, playerNumber);
      }
    });
    playersRef.on('child_removed', snap=>{
      const key = snap.key;
      const el = document.getElementById(key);
      if (el) el.remove();
    });
  }

  function renderPlayerFromData(firebaseKey, data, playerNumber){
    const grid = document.getElementById('gridContainer');
    const cell = document.createElement('div');
    cell.className = 'player-cell';
    cell.id = firebaseKey;
    cell.dataset.playerNumber = playerNumber;
    cell.innerHTML = `
      <div class="player-title">${data.title || 'Player ' + playerNumber}</div>
      <div class="player-meta">ID: <span class="meta-peerid">${data.peerId || '—'}</span></div>
      <div class="cell-content"><div class="placeholder muted small">Player listo — sin compartir</div></div>
      <div class="controls-row">
        <button class="btn btn-sm btn-outline-primary add-tab-btn">Compartir Tab</button>
        <button class="btn btn-sm btn-outline-secondary copy-peer-btn">Copiar PeerID</button>
      </div>
      <button class="delete-player">&times;</button>
      <span class="badge badge-secondary badge-status">idle</span>
    `;
    grid.prepend(cell);

    const badge = cell.querySelector('.badge-status');
    const metaPeer = cell.querySelector('.meta-peerid');

    // delete
    cell.querySelector('.delete-player').addEventListener('click', ()=>{
      // stop stream if active
      if (cell._stream) {
        cell._stream.getTracks().forEach(t=>t.stop());
      }
      // destroy peer if exists
      if (cell._playerPeer) {
        try { cell._playerPeer.destroy(); } catch(e) {}
      }
      playersRef.child(firebaseKey).remove();
      cell.remove();
    });

    // copy peer id
    cell.querySelector('.copy-peer-btn').addEventListener('click', ()=>{
      navigator.clipboard.writeText(metaPeer.textContent || '').then(()=>toast('PeerID copiado','success')).catch(()=>toast('No se pudo copiar','danger'));
    });

    // add-tab (share screen)
    cell.querySelector('.add-tab-btn').addEventListener('click', async ()=>{
      const contentDiv = cell.querySelector('.cell-content');
      contentDiv.innerHTML = `<div class="placeholder muted small">Solicitando pantalla...</div>`;
      badge.className = 'badge badge-info badge-status';
      badge.textContent = 'preparing';

      const q = document.getElementById('qualitySelect').value.split('@')[0].split('x');
      const fps = parseInt(document.getElementById('qualitySelect').value.split('@')[1]) || 15;
      const width = parseInt(q[0]) || 1280;
      const height = parseInt(q[1]) || 720;

      try {
        const stream = await navigator.mediaDevices.getDisplayMedia({
          video: { width, height, frameRate: fps },
          audio: false
        });
        cell._stream = stream;

        // create peer for this player
        const peer = new Peer(peerOptions());
        cell._playerPeer = peer;

        peer.on('error', err=>{ console.error('Peer error', err); toast('Peer error: '+ (err.message || err),'danger') });

        peer.on('open', id=>{
          metaPeer.textContent = id;
          playersRef.child(cell.id).update({ peerId: id, title: `Player ${playerNumber}` });
          badge.className = 'badge badge-success badge-status';
          badge.textContent = 'sharing';
        });

        // handle data connections
        peer.on('connection', conn=>{
          conn.on('open', ()=>{
            conn.on('data', msg=>{
              if (msg && msg.type === 'request'){
                playersRef.child(cell.id).once('value').then(snap=>{
                  const d = snap.val() || {};
                  if (!d.locked){
                    playersRef.child(cell.id).update({ locked: true, viewerUid: msg.viewerUid || msg.viewerId || 'unknown' });
                    // call viewer
                    const call = peer.call(conn.peer, stream);
                    call.on('error', e=>console.error('Call error', e));
                  } else {
                    conn.send({ type:'locked' });
                  }
                });
              } else if (msg && msg.type === 'control'){
                // Emit custom event so page (if embedding Roblox web) can react
                const ev = new CustomEvent('remote-control', { detail: msg });
                window.dispatchEvent(ev);
              }
            });
          });
        });

        // answer incoming calls (if viewer initiates)
        peer.on('call', call => call.answer(stream));

        // when stream ends
        stream.getTracks().forEach(t=>t.onended = ()=> stopStreamAndCleanup(cell));

        // show local preview
        const v = document.createElement('video');
        v.autoplay = true; v.playsInline = true; v.muted = true;
        v.srcObject = stream;
        contentDiv.innerHTML = ''; contentDiv.appendChild(v);

        // toggle button to stop
        const addBtn = cell.querySelector('.add-tab-btn');
        addBtn.textContent = 'Detener';
        addBtn.classList.remove('btn-outline-primary'); addBtn.classList.add('btn-outline-danger');
        addBtn.onclick = ()=> { stream.getTracks().forEach(t=>t.stop()); stopStreamAndCleanup(cell); };

      } catch (err) {
        console.error('getDisplayMedia error', err);
        contentDiv.innerHTML = `<div class="placeholder muted small text-danger">Error: ${err.message}</div>`;
        badge.className = 'badge badge-danger badge-status';
        badge.textContent = 'error';
        toast('No se pudo compartir pantalla: ' + (err.message||err),'danger');
      }
    });
  }

  function stopStreamAndCleanup(cell){
    try {
      if (cell._playerPeer) { cell._playerPeer.destroy(); cell._playerPeer = null; }
    } catch(e){}
    if (cell._stream) {
      cell._stream.getTracks().forEach(t=>t.stop());
      cell._stream = null;
    }
    playersRef.child(cell.id).update({ peerId:'', locked:false, viewerUid:'' });
    const content = cell.querySelector('.cell-content');
    if (content) content.innerHTML = `<div class="placeholder muted small">Player listo — sin compartir</div>`;
    const addBtn = cell.querySelector('.add-tab-btn');
    if (addBtn) { addBtn.textContent = 'Compartir Tab'; addBtn.classList.remove('btn-outline-danger'); addBtn.classList.add('btn-outline-primary'); addBtn.onclick = null; }
    const badge = cell.querySelector('.badge-status');
    if (badge) { badge.className = 'badge badge-secondary badge-status'; badge.textContent = 'idle'; }
  }

  function addPlayerCell(){
    const playerNumber = getNextPlayerNumber();
    broadcasterPlayers.push(playerNumber);
    const cellId = `player-${playerNumber}`;
    playersRef.child(cellId).set({ title:`Player ${playerNumber}`, peerId:'', viewerUid:'', locked:false });
    toast('Player creado: ' + cellId, 'success');
  }

  // ---- Viewer code (mejoras: reusar un peer, evitar listeners duplicados) ----
  let viewerPeer = null;
  function initViewer(){
    const container = document.getElementById('gridContainer');
    // clear only viewer-specific UIs (we'll create a small UI row)
    const viewerRow = document.createElement('div');
    viewerRow.className = 'card p-2';
    viewerRow.innerHTML = `
      <div class="d-flex flex-column">
        <div class="d-flex gap-2 align-items-center mb-2">
          <select class="form-control player-select" style="flex:1"><option value="">Selecciona un Player</option></select>
          <button class="btn btn-primary btn-sm connect-btn">Conectar</button>
          <button class="btn btn-outline-secondary btn-sm disconnect-btn" style="display:none">Desconectar</button>
        </div>
        <div class="viewer-area" style="min-height:220px;display:flex;align-items:center;justify-content:center">Sin conexión</div>
      </div>
    `;
    container.prepend(viewerRow);

    const selectElem = viewerRow.querySelector('.player-select');
    const connectBtn = viewerRow.querySelector('.connect-btn');
    const disconnectBtn = viewerRow.querySelector('.disconnect-btn');
    const viewerArea = viewerRow.querySelector('.viewer-area');

    function refreshOptions(){
      playersRef.once('value').then(snap=>{
        const players = snap.val() || {};
        selectElem.innerHTML = '<option value="">Selecciona un Player</option>';
        for (const key in players){
          const opt = document.createElement('option');
          opt.value = key;
          opt.textContent = players[key].title || key;
          selectElem.appendChild(opt);
        }
      });
    }
    refreshOptions();
    document.getElementById('btnRefreshPlayers').addEventListener('click', refreshOptions);

    if (!viewerPeer){
      viewerPeer = new Peer(peerOptions());
      viewerPeer.on('error', e=>{ console.error('Viewer peer error', e); toast('Viewer Peer error: ' + (e.message||e),'danger') });
      viewerPeer.on('open', id=> console.log('Viewer ready', id));
      // when remote stream arrives
      viewerPeer.on('call', call=>{
        call.answer(); // no local stream
        call.on('stream', remoteStream=>{
          viewerArea.innerHTML = '';
          const v = document.createElement('video');
          v.autoplay = true; v.playsInline = true; v.srcObject = remoteStream;
          viewerArea.appendChild(v);
          disconnectBtn.style.display = 'inline-block';
        });
        call.on('error', e=>{ console.error('Call error on viewer', e); toast('Call error','danger') });
      });
    }

    // connect
    connectBtn.addEventListener('click', ()=>{
      const nodeKey = selectElem.value;
      if (!nodeKey) { toast('Selecciona un Player','info'); return; }
      playersRef.child(nodeKey).once('value').then(snap=>{
        const d = snap.val() || {};
        if (!d.peerId) { toast('Ese Player no está compartiendo aún','danger'); return; }
        // claim viewer
        playersRef.child(nodeKey).update({ viewerUid: auth.currentUser.uid });
        // open data connection to request stream/control
        const dataConn = viewerPeer.connect(d.peerId);
        dataConn.on('open', ()=>{
          dataConn.send({ type:'request', viewerUid: auth.currentUser.uid });
          viewerRow._dataConn = dataConn;
          toast('Solicitud enviada', 'success');
        });
        dataConn.on('error', e=>{ console.error('DataConn error', e); toast('DataConn error','danger') });
      });
    });

    disconnectBtn.addEventListener('click', ()=>{
      // close dataConn
      try {
        if (viewerRow._dataConn) { viewerRow._dataConn.close(); viewerRow._dataConn = null; }
      } catch(e){}
      // destroy peer (optional) — we'll keep peer alive but clear UI
      viewerArea.innerHTML = 'Desconectado';
      disconnectBtn.style.display = 'none';
      toast('Desconectado', 'info');
    });

    // control messages: send keyboard/mouse only once per page (avoid duplicates)
    if (!viewerControlListenersAdded){
      viewerControlListenersAdded = true;
      window.addEventListener('keydown', e=>{
        // find active viewerRow with open dataConn
        const el = document.querySelector('.card .disconnect-btn[style*="display: inline-block"]');
        if (!el) return; // no active disconnect => not connected
        // navigate to parent to retrieve dataConn
        const parent = el.closest('.card');
        if (!parent || !parent._dataConn || parent._dataConn.open !== true) return;
        parent._dataConn.send({ type:'control', kind:'key', key:e.key, code:e.code, meta:{ctrl:e.ctrlKey, alt:e.altKey, shift:e.shiftKey} });
      });
      window.addEventListener('click', e=>{
        const el = document.querySelector('.card .disconnect-btn[style*="display: inline-block"]');
        if (!el) return;
        const parent = el.closest('.card');
        if (!parent || !parent._dataConn || parent._dataConn.open !== true) return;
        parent._dataConn.send({ type:'control', kind:'mouse', x:e.clientX, y:e.clientY, button:e.button });
      });
    }
  }

  // small helper to load list (used by refresh)
  function loadPlayersList(){ playersRef.once('value').then(()=>{}).catch(()=>{}); }

  // React to remote-control on broadcaster page (useful if embedding Roblox web inside)
  window.addEventListener('remote-control', ev=>{
    const d = ev.detail || {};
    console.log('remote-control', d);
    if (d.kind === 'key') {
      const ke = new KeyboardEvent('keydown', { key: d.key, code: d.code, bubbles: true });
      (document.activeElement || document.body).dispatchEvent(ke);
    } else if (d.kind === 'mouse') {
      const me = new MouseEvent('click', { clientX: d.x, clientY: d.y, button: d.button, bubbles: true });
      (document.elementFromPoint(d.x, d.y) || document.body).dispatchEvent(me);
    }
  });

  </script>
</body>
</html>
