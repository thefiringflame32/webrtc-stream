<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Live Tab Sharing — Mejorado (Auth + Full Host/Viewer)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/4.5.2/flatly/bootstrap.min.css"/>
  <style>
    :root{
      --card-radius:18px;
      --muted:#6b7280;
      --accent:#2563eb;
      --bg:#f6f8fb;
      --panel:#ffffff;
      --star-color:#f59e0b;
      --accent-2:#0ea5a4;
    }
    html,body{height:100%;}
    body{background:linear-gradient(180deg,#eef6ff 0%, #fbfcff 100%);font-family:Inter, 'Segoe UI', Roboto, system-ui, sans-serif;margin:0;padding:18px;color:#111}

    /* Stage */
    .stage{max-width:1320px;margin:0 auto;height:calc(100vh - 36px);display:flex;align-items:flex-start;gap:28px}

    /* LEFT info column */
    .left-col{width:260px;display:flex;flex-direction:column;gap:14px}
    .logo-top{height:66px;width:220px;border-radius:12px;background:var(--panel);display:flex;align-items:center;padding:10px 14px;box-shadow:0 8px 22px rgba(16,24,40,.06)}
    .logo-top .r{font-weight:900;color:var(--accent);font-family:'Segoe UI',Arial;}
    .logo-top .life{font-weight:800;margin-left:6px;color:#444}
    .logo-top .share{font-weight:900;margin-left:8px;color:#222;font-size:1.1rem}
    .info-card{flex:1;border-radius:14px;background:var(--panel);padding:18px;box-shadow:0 10px 30px rgba(16,24,40,.04);position:relative;overflow:hidden}
    .info-card h5{margin:0 0 8px 0}
    .info-dots{color:rgba(0,0,0,.45);line-height:20px}
    .big-answer{
      margin-top:12px;
      background:linear-gradient(180deg,#fbfdff,#f8fbff);
      border-radius:12px;padding:18px;border:2px solid rgba(0,0,0,.05);min-height:200px;box-sizing:border-box;color:#1f2937
    }
    .question-buttons{display:flex;flex-direction:row;gap:10px;margin-top:12px}
    .q-btn{flex:1;height:48px;border-radius:10px;border:2px solid rgba(0,0,0,.06);background:var(--panel);display:flex;align-items:center;justify-content:center;font-weight:700;cursor:pointer}
    .q-btn:hover{box-shadow:0 6px 20px rgba(16,24,40,.06)}

    /* CENTER auth card */
    .center-col{flex:1;display:flex;align-items:center;justify-content:center}
    .auth-card{width:820px;border-radius:28px;background:linear-gradient(180deg,#f8fbff,#f4f8ff);padding:28px 28px 44px 28px;box-shadow:0 24px 80px rgba(12,30,60,.06);position:relative}
    .corner-logo{position:absolute;left:18px;top:12px;width:160px;height:44px;border-radius:10px;background:var(--panel);display:flex;align-items:center;justify-content:center;font-weight:900;color:var(--accent);box-shadow:0 8px 24px rgba(12,30,60,.04);font-family:'Segoe UI',Arial}
    .corner-logo .line1{font-size:.9rem}
    .corner-logo .line2{font-size:1.1rem}
    .auth-tabs{display:flex;gap:12px;justify-content:flex-start;margin-bottom:28px}
    .tab{padding:12px 22px;border-radius:12px;background:var(--panel);border:2px solid rgba(0,0,0,.06);text-align:center;font-weight:800;font-size:1.02rem;cursor:pointer}
    .tab.active{border-color:rgba(37,99,235,.18);box-shadow:inset 0 -4px 0 rgba(37,99,235,.06)}
    .auth-body{display:flex;flex-direction:column;align-items:center;gap:12px}
    .big-input{width:460px;padding:16px;border-radius:12px;border:2px solid rgba(0,0,0,.08);background:var(--panel);font-size:1rem}
    .muted-link{font-size:0.95rem;color:var(--muted);text-decoration:underline;cursor:pointer}
    .submit-btn{margin-top:8px;width:320px;padding:14px;border-radius:12px;border:none;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white;font-weight:800;cursor:pointer;box-shadow:0 8px 30px rgba(37,99,235,.14)}

    /* RIGHT reviews rail (vertical stars) */
    .right-col{width:140px;display:flex;flex-direction:column;align-items:center}
    .reviews-rail{width:140px;border-radius:12px;background:var(--panel);padding:16px;display:flex;flex-direction:column;align-items:center;justify-content:space-between;height:calc(100vh - 120px);box-shadow:0 12px 36px rgba(12,30,60,.04)}
    .reviews-rail h5{margin:0;font-weight:800;letter-spacing:0.6px}
    .stars-vertical{display:flex;flex-direction:column;gap:12px;margin-top:16px;align-items:center}
    .star-big{width:44px;height:44px}
    .rating-bubble{background:linear-gradient(90deg,#fff,#fbfdff);border-radius:12px;padding:8px 12px;font-weight:800;border:1px solid rgba(0,0,0,.06);font-size:1rem;box-shadow:0 8px 20px rgba(12,30,60,.04)}

    /* Viewer area center content */
    .viewer-main{background:var(--panel);border-radius:20px;padding:24px;box-shadow:0 20px 60px rgba(12,30,60,.05);min-height:500px}
    #playersGridViewer{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}

    /* Responsive */
    @media(max-width:1100px){
      .stage{flex-direction:column;align-items:stretch;height:auto}
      .left-col,.right-col{width:100%}
      .auth-card{width:100%;border-radius:18px;padding:18px}
      .reviews-rail{height:360px}
      #playersGridViewer{grid-template-columns:repeat(2,1fr)}
    }
  </style>
</head>
<body>

  <!-- AUTH stage -->
  <div class="stage" id="authStart">
    <!-- LEFT: viewer Q&A -->
    <div class="left-col">
      <div class="logo-top">
        <div style="display:flex;flex-direction:column;">
          <div style="font-size:14px;line-height:1"><span class="r">R</span><span class="life">oblox</span></div>
          <div style="font-size:13px;margin-top:2px"><span style="font-weight:800">Life</span> <span style="font-weight:900;color:#333">SHARE</span></div>
        </div>
      </div>

      <div class="info-card" id="infoCard">
        <h5 id="mainQTitle">What is this for?</h5>
        <div class="big-answer" id="mainAnswer">
          Live Tab Sharing lets a host share a browser tab or entire screen in real time. Hosts create a Player, start sharing their screen via WebRTC and viewers connect using the Player's PeerID to watch. The host controls access (can kick viewers), chooses stream quality, and may enable optional remote control features. Streams are encrypted and session metadata (peer IDs, timestamps) are stored in Firebase for session and viewer management.
        </div>

        <div class="question-buttons" style="margin-top:14px">
          <div id="qBtn1" class="q-btn">Why choose us?</div>
          <div id="qBtn2" class="q-btn">What about privacy?</div>
        </div>
      </div>
    </div>

    <!-- CENTER: auth card -->
    <div class="center-col">
      <div class="auth-card" role="main" aria-labelledby="authTitle">
        <div class="corner-logo"><div style="display:flex;flex-direction:column;align-items:center"><span class="line1">Roblox Life</span><span class="line2">SHARE</span></div></div>

        <div class="auth-tabs">
          <div id="tabLogin" class="tab active">LOGIN</div>
          <div id="tabRegister" class="tab">REGISTER</div>
        </div>

        <div class="auth-body" id="authBody">
          <!-- LOGIN -->
          <div id="loginForm" style="width:100%;display:flex;flex-direction:column;align-items:center;gap:12px">
            <input id="visualEmail" class="big-input" placeholder="Username/Email..." type="email" />
            <input id="visualPassword" class="big-input" placeholder="Password..." type="password" />
            <a id="forgotLink" class="muted-link">Forgot your password</a>
            <button id="visualSubmit" class="submit-btn">SUBMIT</button>
            <div id="loginMsg" class="small-muted" style="margin-top:6px"></div>
          </div>

          <!-- REGISTER -->
          <div id="registerForm" style="width:100%;display:none;flex-direction:column;align-items:center;gap:12px">
            <input id="regEmail" class="big-input" placeholder="Correo" type="email" />
            <input id="regPassword" class="big-input" placeholder="Contraseña" type="password" />
            <input id="regUsername" class="big-input" placeholder="Nombre (username público)" type="text" />
            <div style="display:flex;gap:8px">
              <button id="registerBtnVisual" class="submit-btn" style="width:140px">Crear</button>
              <button id="cancelRegVisual" class="submit-btn" style="width:140px;background:#fff;color:#111;border:1px solid rgba(0,0,0,.06)">Cancelar</button>
            </div>
            <div id="regMsg" class="small-muted"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT: reviews rail -->
    <div class="right-col">
      <div class="reviews-rail" aria-hidden="false">
        <div style="text-align:center"><h5>REVIEWS</h5></div>
        <div class="stars-vertical" id="starsRail" style="margin-top:12px">
          <svg class="star-big" viewBox="0 0 24 24"><path fill="var(--star-color)" d="M12 .587l3.668 7.431L23.5 9.75l-5.667 5.535L19.335 24 12 19.897 4.665 24l1.502-8.715L.5 9.75l7.832-1.732z"/></svg>
          <svg class="star-big" viewBox="0 0 24 24"><path fill="var(--star-color)" d="M12 .587l3.668 7.431L23.5 9.75l-5.667 5.535L19.335 24 12 19.897 4.665 24l1.502-8.715L.5 9.75l7.832-1.732z"/></svg>
          <svg class="star-big" viewBox="0 0 24 24"><path fill="var(--star-color)" d="M12 .587l3.668 7.431L23.5 9.75l-5.667 5.535L19.335 24 12 19.897 4.665 24l1.502-8.715L.5 9.75l7.832-1.732z"/></svg>
          <svg class="star-big" viewBox="0 0 24 24"><path fill="var(--star-color)" d="M12 .587l3.668 7.431L23.5 9.75l-5.667 5.535L19.335 24 12 19.897 4.665 24l1.502-8.715L.5 9.75l7.832-1.732z"/></svg>
          <svg class="star-big" viewBox="0 0 24 24"><defs><linearGradient id="gPartialV2" x1="0" x2="1" y1="0" y2="0"><stop offset="0%" stop-color="var(--star-color)"/><stop offset="92%" stop-color="var(--star-color)"/><stop offset="92.1%" stop-color="#e6e6e6"/><stop offset="100%" stop-color="#e6e6e6"/></linearGradient></defs><path fill="url(#gPartialV2)" d="M12 .587l3.668 7.431L23.5 9.75l-5.667 5.535L19.335 24 12 19.897 4.665 24l1.502-8.715L.5 9.75l7.832-1.732z"/></svg>
        </div>

        <div class="rating-bubble" style="margin-top:18px">4.92 / 5</div>
      </div>
    </div>
  </div>

  <!-- VIEWER UI (shown after login if user is not owner) -->
  <div id="viewerFull" style="display:none;max-width:1320px;margin:18px auto;">
    <div class="viewer-main">
      <h4 style="text-align:center;margin-bottom:12px">Available Players</h4>
      <div id="playersGridViewer" style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:12px"></div>

      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-top:12px">
        <div style="flex:1;margin-right:12px">
          <h6>Connections</h6>
          <div id="connectedList" class="connected-list">
            <div class="small-muted">No estás conectado a ningún Player.</div>
          </div>
        </div>
        <div style="width:220px">
          <h6>Status</h6>
          <div class="small-muted">PeerJS: <span id="peerLabel">Cloud</span></div>
          <div class="small-muted">Firebase: <span id="fbLabel">Desconocido</span></div>
        </div>
      </div>
    </div>
  </div>

  <!-- APP (host) area placeholder; full host logic below will populate this region when owner is signed in -->
  <div id="appMain" style="display:none">
    <div style="max-width:1200px;margin:18px auto;padding:18px;background:var(--panel);border-radius:12px;box-shadow:0 12px 36px rgba(12,30,60,.04)">
      <h3>Host view (Players)</h3>
      <div id="playersGrid" style="margin-top:12px;display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px"></div>
    </div>
  </div>

  <!-- Firebase & PeerJS libs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/peerjs@1.4.7/dist/peerjs.min.js"></script>

  <script>
    /*********************** CONFIG ***********************/
    const firebaseConfig = {
      apiKey: "AIzaSyDLQGyXjRwrJ9O6RbVFtp-4uRNepAWdfrU",
      authDomain: "thefiringflame3210.firebaseapp.com",
      databaseURL: "https://thefiringflame3210-default-rtdb.firebaseio.com",
      projectId: "thefiringflame3210",
      storageBucket: "thefiringflame3210.appspot.com",
      messagingSenderId: "759308762331",
      appId: "1:759308762331:web:79725eda7c24b346eca0fe"
    };
    const ICE_SERVERS = [{ urls: 'stun:stun.l.google.com:19302' }, { urls: 'stun:stun1.l.google.com:19302' }];
    /*****************************************************/

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    const playersRef = db.ref('players');
    const usersRef = db.ref('users');

    function el(id){ return document.getElementById(id); }
    function showAuthStart(){ el('authStart').style.display='flex'; el('appMain').style.display='none'; el('viewerFull').style.display='none'; }
    function showViewerFull(){ el('authStart').style.display='none'; el('viewerFull').style.display='block'; el('appMain').style.display='none'; }
    function showAppMain(){ el('authStart').style.display='none'; el('viewerFull').style.display='none'; el('appMain').style.display='block'; }

    // toast helper
    function toast(msg, type='info'){
      console.log(type, msg);
      const t = document.createElement('div');
      t.style.position='fixed'; t.style.right='18px'; t.style.bottom='18px';
      t.style.background='rgba(0,0,0,.75)'; t.style.color='white'; t.style.padding='10px 12px'; t.style.borderRadius='8px';
      t.style.zIndex = 9999; t.innerText = msg;
      document.body.appendChild(t); setTimeout(()=>t.remove(),3000);
    }

    // QUESTIONS (10) logic already initialized earlier in UI; no changes needed here

    // AUTH UI wiring (tabs)
    el('tabLogin').addEventListener('click', ()=>{ el('tabLogin').classList.add('active'); el('tabRegister').classList.remove('active'); el('loginForm').style.display='flex'; el('registerForm').style.display='none'; });
    el('tabRegister').addEventListener('click', ()=>{ el('tabRegister').classList.add('active'); el('tabLogin').classList.remove('active'); el('loginForm').style.display='none'; el('registerForm').style.display='flex'; });

    // LOGIN
    el('visualSubmit').addEventListener('click', async ()=>{
      const email = el('visualEmail').value.trim();
      const pass = el('visualPassword').value;
      if (!email || !pass) { el('loginMsg').innerText = 'Introduce email y contraseña'; return; }
      el('loginMsg').innerText = 'Iniciando sesión...';
      try {
        await auth.signInWithEmailAndPassword(email, pass);
        el('loginMsg').innerText = 'Sesión iniciada';
      } catch(e){ el('loginMsg').innerText = 'Error: ' + (e.message||e); }
    });

    // REGISTER
    el('registerBtnVisual').addEventListener('click', async ()=>{
      const email = el('regEmail').value.trim();
      const pass = el('regPassword').value;
      const username = el('regUsername').value.trim();
      if (!email || !pass || !username){ el('regMsg').innerText = 'Rellena todos los campos'; return; }
      el('regMsg').innerText = 'Creando cuenta...';
      try {
        const cred = await auth.createUserWithEmailAndPassword(email, pass);
        const uid = cred.user.uid;
        await usersRef.child(uid).set({ username });
        el('regMsg').innerText = 'Cuenta creada. Inicia sesión.';
        el('tabLogin').click(); el('visualEmail').value = email;
      } catch(e){ el('regMsg').innerText = 'Error: ' + (e.message||e); }
    });
    el('cancelRegVisual').addEventListener('click', ()=> el('tabLogin').click() );

    // Forgot password
    el('forgotLink').addEventListener('click', async (ev)=>{
      ev.preventDefault();
      const email = el('visualEmail').value.trim();
      if (!email) return alert('Introduce tu correo en el campo de email para recibir un enlace de recuperación.');
      try { await auth.sendPasswordResetEmail(email); alert('Se ha enviado un correo para restablecer la contraseña.'); } catch(e){ alert('Error: ' + (e.message||e)); }
    });

    // --- Full Player & PeerJS host/viewer logic (re-integrated from original) ---

    // state
    let currentUser = null; let currentProfile = null; let viewerPeer = null; let playersSnapshot = {}; let connectedMap = {};

    function peerOptions(){ return { config:{ iceServers: ICE_SERVERS } }; }

    // viewer peer init
    function ensureViewerPeer(){ if (viewerPeer) return; viewerPeer = new Peer(peerOptions()); viewerPeer.on('open', id=> console.log('Viewer peer open', id)); viewerPeer.on('error', err=> toast('Peer error: '+(err.message||err),'danger'));
      viewerPeer.on('call', call => { const remotePeerId = call.peer; call.on('stream', remoteStream => {
          // attach to connected UI
          const list = el('connectedList'); if (list.children.length === 1 && list.children[0].classList.contains('small-muted')) list.innerHTML = '';
          const wrapper = document.createElement('div'); wrapper.style.border='1px solid rgba(0,0,0,.06)'; wrapper.style.padding='8px'; wrapper.style.borderRadius='8px'; wrapper.style.marginBottom='8px';
          const title = document.createElement('div'); title.style.fontWeight='700'; title.innerText = 'Player: ' + remotePeerId;
          const video = document.createElement('video'); video.autoplay = true; video.playsInline = true; video.srcObject = remoteStream; video.style.width='100%'; video.style.maxHeight='200px'; video.style.marginTop='8px';
          wrapper.appendChild(title); wrapper.appendChild(video); list.appendChild(wrapper);
          // cleanup on end
          remoteStream.getTracks().forEach(t=> t.onended = ()=> wrapper.remove());
        }); }); }

    // render players for viewer
    function renderPlayersViewer(snapshot){ const container = el('playersGridViewer'); if (!container) return; container.innerHTML = ''; for(const pid in snapshot){ const p = snapshot[pid]||{}; const div = document.createElement('div'); div.style.border='1px solid rgba(0,0,0,.06)'; div.style.borderRadius='12px'; div.style.padding='12px'; div.style.background='#fbfdff'; div.style.cursor='pointer';
        const title = document.createElement('div'); title.style.fontWeight='700'; title.innerText = p.title||pid;
        const owner = document.createElement('div'); owner.style.color='var(--muted)'; owner.style.fontSize='.9rem'; owner.innerText = 'Owner: ' + (p.ownerName||p.owner||'—');
        const preview = document.createElement('div'); preview.style.marginTop='8px'; preview.style.height='110px'; preview.style.borderRadius='8px'; preview.style.display='flex'; preview.style.alignItems='center'; preview.style.justifyContent='center'; preview.style.background='linear-gradient(180deg,#fff,#f7fbff)'; preview.innerText = p.peerId ? 'Compartiendo' : 'No comparte';
        div.appendChild(title); div.appendChild(owner); div.appendChild(preview);
        div.addEventListener('click', ()=> connectToPlayerAsViewer(pid)); container.appendChild(div);
      } }

    // render host players (detailed like original)
    function renderPlayersHost(snapshot){ const container = el('playersGrid'); if (!container) return; container.innerHTML = ''; for (const playerId in snapshot){ const p = snapshot[playerId] || {}; const elDiv = document.createElement('div'); elDiv.className = 'player'; elDiv.id = 'pl-' + playerId; elDiv.style.background='linear-gradient(180deg,#ffffff,#fbfdff)'; elDiv.style.borderRadius='10px'; elDiv.style.padding='10px'; elDiv.style.border='1px solid rgba(30,41,55,.06)'; elDiv.style.position='relative'; elDiv.style.minHeight='160px'; elDiv.style.display='flex'; elDiv.style.flexDirection='column';
        const title = p.title || playerId; const ownerUid = p.owner || '—'; const ownerName = (p.owner && p.ownerName) ? p.ownerName : (p.ownerName || ownerUid); const peerId = p.peerId || ''; const viewers = p.viewers || {};
        elDiv.innerHTML = `<div style="font-weight:700;color:#0b2b66">${title}</div><div style="font-size:.85rem;color:var(--muted);margin-top:6px">Owner: <strong>${ownerName}</strong> • Peer: <span class="peer-id">${peerId || '—'}</span></div><div class="preview" style="flex:1;border-radius:8px;margin-top:8px;overflow:hidden;background:linear-gradient(180deg,#f7fbff,#ffffff);display:flex;align-items:center;justify-content:center"><div class="muted small">No se comparte</div></div><div class="actions" style="display:flex;gap:6px;margin-top:8px"><button class="btn btn-sm btn-outline-primary share-btn">${peerId ? 'Compartiendo' : 'Compartir'}</button><button class="btn btn-sm btn-outline-secondary copy-btn">Copiar Peer</button><button class="btn btn-sm btn-outline-danger kick-all-btn">Kick All</button></div><button class="delete-btn" title="Eliminar" style="position:absolute;top:10px;right:10px;border:none;background:transparent;color:#e04b4b;font-weight:700">×</button><div style="margin-top:8px"><div class="small-muted">Conectados:</div><div class="viewer-list small-muted" style="margin-top:6px;max-height:90px;overflow:auto"></div></div>`;

        // populate viewer list
        const viewerListDiv = elDiv.querySelector('.viewer-list'); if (Object.keys(viewers).length === 0) { viewerListDiv.innerHTML = `<div class="muted small">Nadie conectado</div>`; } else { viewerListDiv.innerHTML = ''; for (const uid in viewers) { const v = viewers[uid] || {}; const item = document.createElement('div'); item.style.display = 'flex'; item.style.justifyContent = 'space-between'; item.style.alignItems = 'center'; item.style.marginBottom = '6px'; item.innerHTML = `<div>${v.username || uid} ${v.kicked ? '(kicked)' : v.active ? '(activo)' : '(inactivo)'}</div><div><button class="btn btn-sm btn-outline-danger kick-btn">Kick</button></div>`; const kickBtn = item.querySelector('.kick-btn'); kickBtn.addEventListener('click', ()=> { if (!currentUser || currentUser.uid !== p.owner) return toast('Solo el owner puede kickear','danger'); playersRef.child(playerId).child('viewers').child(uid).update({ kicked: true, active: false }); toast('Kick enviado a ' + (v.username||uid),'info'); }); viewerListDiv.appendChild(item); } }

        // attach actions
        elDiv.querySelector('.share-btn').addEventListener('click', ()=>{ if (!currentUser || currentUser.uid !== p.owner) return toast('Solo el owner puede compartir','danger'); startSharingForExistingPlayer(playerId, elDiv); });
        elDiv.querySelector('.copy-btn').addEventListener('click', ()=>{ const pid = elDiv.querySelector('.peer-id').textContent; if (!pid || pid === '—') return toast('No hay PeerID','info'); navigator.clipboard.writeText(pid).then(()=>toast('PeerID copiado','success')).catch(()=>toast('No se pudo copiar','danger')); });
        elDiv.querySelector('.delete-btn').addEventListener('click', ()=>{ if (!currentUser) return toast('No autenticado','info'); if (p.owner && currentUser.uid !== p.owner) return toast('Solo el owner puede eliminar','danger'); playersRef.child(playerId).remove(); toast('Player eliminado','info'); });
        elDiv.querySelector('.kick-all-btn').addEventListener('click', ()=>{ if (!currentUser || currentUser.uid !== p.owner) return toast('Solo el owner puede kickear','danger'); const viewersNode = playersRef.child(playerId).child('viewers'); for (const uid in viewers) { viewersNode.child(uid).update({ kicked: true, active: false }); } toast('Kick all enviado','info'); });
        // preview placeholder update
        if (peerId){ const preview = elDiv.querySelector('.preview'); preview.innerHTML = `<div class="muted small">Player está compartiendo — espera conexión</div>`; }
        container.appendChild(elDiv);
      }
    }

    // add player
    function getNextPlayerNumber(){ return Object.keys(playersSnapshot || {}).length + 1; }
    document.addEventListener('click', function(e){ if (e.target && e.target.id === 'addPlayer'){ if (!currentUser) return toast('Inicia sesión para crear Player','info'); const idx = getNextPlayerNumber(); const pid = `player-${Date.now()}-${Math.floor(Math.random()*999)}`; const ownerName = currentProfile.username; playersRef.child(pid).set({ owner: currentUser.uid, ownerName: ownerName, title: `Player ${idx}`, peerId: '', viewers: {}, locked: false, createdAt: Date.now() }); toast('Player creado','success'); } });

    // start sharing for existing player (owner flow)
    async function startSharingForExistingPlayer(playerId, elDom){ const pSnap = playersSnapshot[playerId] || {}; if (!currentUser || pSnap.owner !== currentUser.uid) return toast('No eres el owner','danger'); try { const quality = document.getElementById('quality') ? document.getElementById('quality').value.split('@')[0].split('x') : ['1280','720']; const fps = document.getElementById('quality') ? parseInt(document.getElementById('quality').value.split('@')[1] || '15') : 15; const width = parseInt(quality[0]) || 1280; const height = parseInt(quality[1]) || 720; const stream = await navigator.mediaDevices.getDisplayMedia({ video:{ width, height, frameRate: fps }, audio:false }); const peer = new Peer(peerOptions()); elDom._playerPeer = peer; elDom._stream = stream; peer.on('open', id=>{ playersRef.child(playerId).update({ peerId: id, title: pSnap.title || 'Player' }); toast('Peer listo: ' + id, 'success'); }); peer.on('connection', conn=>{ conn.on('open', ()=>{ conn.on('data', data=>{ if (data && data.type === 'request') { const viewerUid = data.viewerUid; const username = data.username || 'guest'; const viewerRef = playersRef.child(playerId).child('viewers').child(viewerUid); viewerRef.update({ username, connectedAt: Date.now(), active: true, kicked: false }); const call = peer.call(conn.peer, stream); call.on('error', e=>console.error('Call err', e)); } else if (data && data.type === 'control') { window.dispatchEvent(new CustomEvent('remote-control', { detail: data })); } }); conn.on('close', ()=>{ /* handle close if needed */ }); }); }); peer.on('call', call => call.answer(stream)); stream.getTracks().forEach(t => t.onended = ()=> { playersRef.child(playerId).update({ peerId: '' }); playersRef.child(playerId).child('viewers').once('value').then(snap=>{ const vs = snap.val() || {}; for (const uid in vs) playersRef.child(playerId).child('viewers').child(uid).update({ active:false }); }); if (elDom._playerPeer) try { elDom._playerPeer.destroy(); } catch(e){} }); const preview = elDom.querySelector('.preview'); preview.innerHTML = ''; const v = document.createElement('video'); v.autoplay = true; v.playsInline = true; v.muted = true; v.srcObject = stream; preview.appendChild(v);
    } catch(e){ toast('Error compartiendo: ' + (e.message || e),'danger'); } }

    // viewer side connect
    function connectToPlayerAsViewer(playerId){ if (!currentUser) return toast('Inicia sesión para conectar','info'); const p = playersSnapshot[playerId] || {}; if (!p.peerId) return toast('Ese player no está compartiendo','info'); const peerId = p.peerId; ensureViewerPeer(); const conn = viewerPeer.connect(peerId, { reliable:true }); conn.on('open', ()=>{ conn.send({ type:'request', viewerUid: currentUser.uid, username: currentProfile.username }); playersRef.child(playerId).child('viewers').child(currentUser.uid).update({ username: currentProfile.username, connectedAt: Date.now(), active:true, kicked:false }); toast('Conectado: ' + (p.title || playerId), 'success'); }); conn.on('error', e=> { console.error('dataConn error', e); toast('Error de conexión','danger') }); }

    // DB listeners
    playersRef.on('value', snap=>{ playersSnapshot = snap.val() || {}; // update UI
      renderPlayersViewer(playersSnapshot); renderPlayersHost(playersSnapshot);
    });

    // DB connected indicator
    db.ref('.info/connected').on('value', snap=> { const v = snap.val(); const fb = el('fbLabel'); if (fb) fb.textContent = v ? 'Conectado' : 'Desconectado'; });

    // auth state
    auth.onAuthStateChanged(async user=>{
      if (!user){ currentUser = null; currentProfile = null; showAuthStart(); return; }
      currentUser = user; const snap = await usersRef.child(user.uid).once('value'); currentProfile = snap.val() || { username: user.email.split('@')[0] };
      // check if owns players
      const playersNow = (await playersRef.once('value')).val() || {};
      const owns = Object.values(playersNow||{}).some(p=> p && p.owner === currentUser.uid);
      if (owns) showAppMain(); else { showViewerFull(); ensureViewerPeer(); }
    });

    // initialize
    setMainQuestion(0); setButtons(); showAuthStart();
  </script>
</body>
</html>
