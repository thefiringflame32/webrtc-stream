<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Broadcaster</title>
  <script src="https://cdn.jsdelivr.net/npm/peerjs@1.4.7/dist/peerjs.min.js"></script>
</head>
<body>
  <h1>Broadcaster</h1>
  <p>Status: <span id="status">Initializing...</span></p>
  <button id="addScreenBtn">Add Screen</button>
  <div id="screensContainer"></div>

  <script>
    const status = msg => document.getElementById('status').textContent = msg;
    const container = document.getElementById('screensContainer');

    async function addScreen() {
      // Create a new Peer for each screen share.
      const screenPeer = new Peer({
        host: 'my-peerjs-server-thefiringflam-121a8798e654.herokuapp.com',
        port: 443,
        secure: true,
        config: { iceServers: [] },
        debug: 2
      });

      // When the Peer is ready, get display media and show the Peer ID.
      screenPeer.on('open', async id => {
        // Get the screen stream.
        let stream;
        try {
          stream = await navigator.mediaDevices.getDisplayMedia({
            video: { width: 1280, height: 720, frameRate: 30 },
            audio: true
          });
        } catch (err) {
          console.error('Error getting display media:', err);
          status('Error: ' + err.message);
          return;
        }

        status(`Screen ready with ID: ${id}`);
        const display = document.createElement('p');
        display.innerHTML = `Screen ID: <b>${id}</b>`;
        container.appendChild(display);

        // Listen for data connections from viewers.
        screenPeer.on('connection', conn => {
          conn.on('open', () => {
            // When the viewer sends their ID over the data connection, initiate a call.
            conn.on('data', data => {
              console.log('Received viewer data:', data);
              // Initiate a call to the viewerâ€™s Peer ID, using the screen stream.
              const call = screenPeer.call(conn.peer, stream);
              call.on('error', err => console.error('Call error:', err));
              call.on('close', () => console.log('Call closed for screen ID:', id));
            });
          });
        });
      });

      screenPeer.on('error', err => {
        console.error('Peer error (screen):', err);
        status('Peer error: ' + err.message);
      });
    }

    document.getElementById('addScreenBtn').addEventListener('click', addScreen);
  </script>
</body>
</html>
